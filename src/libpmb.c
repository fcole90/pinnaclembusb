
#include <stdio.h>
#include <sys/types.h>
#include <unistd.h>
#include <fcntl.h>
#include <usb.h>	// libusb

static struct usb_bus *bus;
static struct usb_bus *dev_bus;
static struct usb_device *dev_dev;
static struct usb_device_descriptor *dev_desc;
static struct usb_config_descriptor *dev_conf;
static struct usb_interface_descriptor *dev_if;
static struct usb_endpoint_descriptor *dev_ep_out[2];
static struct usb_endpoint_descriptor *dev_ep_in[2];
static struct usb_dev_handle *dev_handle = NULL;
static char found = 0;

// array of bytes in A9/AA memory
static unsigned char AABuffer[256];

// I'm too lazy to convert USB Monitor's hex to something C is happy with, so...
static int monhex_len = -1;
static unsigned char monhex_tmp[256];
static unsigned char *monhex(char *str)
{
	char *ostr = str;
	int i=0;

	while (*str) {
		if (i >= 256) {
			fprintf(stderr,"BUG: monhex() given string who's binary equivalent overflows the array!\n");
			fprintf(stderr,"  The string was:\n%s\n",ostr);
			exit(1);
		}

		if (isxdigit(*str)) {
			monhex_tmp[i++] = (unsigned char)strtoul(str,NULL,16);
			while (isxdigit(*str)) str++;
		}
		else {
			str++;
		}
	}

	monhex_len = i;
	return monhex_tmp;
}

// A9_Byte apparently determines the target of the data:
// 0x00: CS4954 video encoder
// 0x18: UDA1380TT audio decoder chip
static unsigned char A9_Byte = 0x21;
static int WriteA9(int index,int data)
{
	unsigned char buf[4];

	if (index > 255)
		return -1;

	buf[0] = A9_Byte;
	buf[1] = 0x02;
	buf[2] = index;
	buf[3] = data;
	if (usb_control_msg(dev_handle,0x40,0xAA,0x00,0,buf,4,1000) < 1) {
		fprintf(stderr,"Cannot initiate AA write in WriteA9\n");
		return -1;
	}

	return 0;
}

static int WriteA9W(int index,int data)
{
	unsigned char buf[5];

	if (index > 255)
		return -1;

	buf[0] = A9_Byte;
	buf[1] = 0x03;
	buf[2] = index;
	buf[3] = data >> 8;
	buf[4] = data;
	if (usb_control_msg(dev_handle,0x40,0xAA,0x00,0,buf,5,1000) < 1) {
		fprintf(stderr,"Cannot initiate AA write in WriteA9W\n");
		return -1;
	}

	return 0;
}

static int ImmReadA9()
{
	unsigned char c;

	if (usb_control_msg(dev_handle,0xC0,0xA9,0x00,0,&c,1,1000) < 1)
		return -1;

	return 0;
}

static int ImmReadAB()
{
	unsigned char buf[2];

	if (usb_control_msg(dev_handle,0xC0,0xAB,0x00,0,buf,2,1000) < 2)
		return -1;

	return (((int)buf[0]) << 8) | ((int)buf[1]);
}

static int ImmReadC4()
{
	unsigned char c;

	if (usb_control_msg(dev_handle,0xC0,0xC4,0x00,0,&c,1,1000) < 1)
		return -1;

	return ((int)c);
}

static int ReadA9(int index)
{
	unsigned char buf[4];

	if (index > 255)
		return -1;

	buf[0] = 0x21;
	buf[1] = 0x02;
	buf[2] = 0x00;
	buf[3] = index;
	if (usb_control_msg(dev_handle,0x40,0xAA,0x00,0,buf,4,1000) < 1) {
		fprintf(stderr,"Cannot initiate AA 1st packet in ReadA9\n");
		return -1;
	}

	buf[0] = 0x21;
	buf[1] = 0x01;
	buf[2] = 0x00;
	if (usb_control_msg(dev_handle,0x40,0xAA,0x00,0,buf,3,1000) < 1) {
		fprintf(stderr,"Cannot initiate AA 2nd packet in ReadA9\n");
		return -1;
	}

	if (usb_control_msg(dev_handle,0xC0,0xA9,0x00,0,buf,1,1000) < 1)
		return -1;

	return ((int)buf[0]);
}

static int knock_knock()
{
// usb_control(handle,request type,request,value,index,bytes,size,timeout);
//
// shorthand SPITA/SPITL(a,b,c,d) send (request a,value b,index c,data d)
	unsigned char _12345[10] = {0,1,2,2,3,3,4,4,5,5};
	unsigned char ONE[1] = {0x01};

#define SPITA(a,b,c,d) \
	if (usb_control_msg(dev_handle,USB_TYPE_VENDOR|USB_RECIP_DEVICE,a,b,c,d,sizeof(d),250) < sizeof(d)) { \
		fprintf(stderr,"Cannot write %u bytes",sizeof(d)); \
		return -1; \
	}
#define SPITS(a,b,c,d) \
	{ unsigned char *bin = monhex(d); \
		if (usb_control_msg(dev_handle,USB_TYPE_VENDOR|USB_RECIP_DEVICE,a,b,c,bin,monhex_len,250) < monhex_len) { \
			fprintf(stderr,"Cannot write %s\n",d); \
			return -1; \
		} \
	}
#define SPITSx(a,b,c,d) \
	{ unsigned char *bin = monhex(d); \
		usb_control_msg(dev_handle,USB_TYPE_VENDOR|USB_RECIP_DEVICE,a,b,c,bin,monhex_len,250); }

	SPITA(0xA0,0x7F92,0x00,ONE);
	SPITA(0xA0,0xE600,0x00,ONE);
	SPITA(0xA0,0x7F92,0x00,ONE);
	SPITA(0xA0,0xE600,0x00,ONE);
	SPITA(0xA0,0x0036,0x00,_12345);
#define X(a,x) SPITS(0xA0,a,0x00,x)
#define AA(x) SPITS(0xAA,0x0000,0x00,x)
#define C5(x) SPITS(0xC5,0x0000,0x00,x)
#define C5x(x) SPITSx(0xC5,0x0000,0x00,x)
	X(0x02D1,"E4 F5 13 F5 12 F5 11 F5 10 C2 11 C2 0E D2 10 C2");
	X(0x02E1,"0F 12 05 92 7E 07 7F 00 8E 46 8F 47 75 4E 07 75");
	X(0x02F1,"4F 12 75 44 07 75 45 1C 75 4C 07 75 4D 4A 75 50");
	X(0x0301,"07 75 51 78 90 E6 80 E0 30 E7 0E 85 44 48 85 45");
	X(0x0311,"49 85 4C 4A 85 4D 4B 80 0C 85 4C 48 85 4D 49 85");
	X(0x0321,"44 4A 85 45 4B EE 54 E0 70 03 02 04 3A 75 14 00");
	X(0x0331,"75 15 80 7E 07 7F 00 8E 16 8F 17 C3 74 BC 9F FF");
	X(0x0341,"74 07 9E CF 24 02 CF 34 00 FE E4 8F 0F 8E 0E F5");
	X(0x0351,"0D F5 0C F5 0B F5 0A F5 09 F5 08 AF 0F AE 0E AD");
	X(0x0361,"0D AC 0C AB 0B AA 0A A9 09 A8 08 C3 12 09 6C 50");
	X(0x0371,"26 E5 15 25 0B F5 82 E5 14 35 0A F5 83 74 CD F0");
	X(0x0381,"E5 0B 24 01 F5 0B E4 35 0A F5 0A E4 35 09 F5 09");
	X(0x0391,"E4 35 08 F5 08 80 C4 E4 F5 0B F5 0A F5 09 F5 08");
	X(0x03A1,"AF 0F AE 0E AD 0D AC 0C AB 0B AA 0A A9 09 A8 08");
	X(0x03B1,"C3 12 09 6C 50 31 AE 0A AF 0B E5 17 2F F5 82 E5");
	X(0x03C1,"16 3E F5 83 E0 FD E5 15 2F F5 82 E5 14 3E F5 83");
	X(0x03D1,"ED F0 EF 24 01 F5 0B E4 3E F5 0A E4 35 09 F5 09");
	X(0x03E1,"E4 35 08 F5 08 80 B9 85 14 46 85 15 47 74 00 24");
	X(0x03F1,"80 FF 74 07 34 FF FE C3 E5 4F 9F F5 4F E5 4E 9E");
	X(0x0401,"F5 4E C3 E5 49 9F F5 49 E5 48 9E F5 48 C3 E5 4B");
	X(0x0411,"9F F5 4B E5 4A 9E F5 4A C3 E5 45 9F F5 45 E5 44");
	X(0x0421,"9E F5 44 C3 E5 4D 9F F5 4D E5 4C 9E F5 4C C3 E5");
	X(0x0431,"51 9F F5 51 E5 50 9E F5 50 D2 E8 43 D8 20 90 E6");
	X(0x0441,"68 E0 44 09 F0 90 E6 5C E0 44 3D F0 D2 AF 90 E6");
	X(0x0451,"80 E0 20 E1 05 D2 12 12 00 03 E5 80 30 E2 10 7F");
	X(0x0461,"F4 7E 01 12 09 D0 90 E6 80 E0 54 F7 F0 80 03 12");
	X(0x0471,"0B 14 53 8E F8 C2 11 E5 80 20 E2 03 12 0B 14 30");
	X(0x0481,"0F F5 12 00 56 C2 0F 80 EE");

	X(0x0B14,"90 E6 80 E0 44 08 F0 E5 80 30 E2 FB 7F F4 7E 01");
	X(0x0B24,"12 09 D0 90 E6 80 E0 54 F7 F0 22");

	X(0x0056,"90 E6 B9 E0 70 03 02 01 29 14 70 03 02 01 CA 24");
	X(0x0066,"FE 70 03 02 02 56 24 FB 70 03 02 01 23 14 70 03");
	X(0x0076,"02 01 1D 14 70 03 02 01 11 14 70 03 02 01 17 24");
	X(0x0086,"05 60 03 02 02 BD 90 E6 BB E0 24 FE 60 2C 14 60");
	X(0x0096,"47 24 FD 60 16 14 60 31 24 06 70 65 E5 46 90 E6");
	X(0x00A6,"B3 F0 E5 47 90 E6 B4 F0 02 02 C9 E5 4E 90 E6 B3");
	X(0x00B6,"F0 E5 4F 90 E6 B4 F0 02 02 C9 E5 48 90 E6 B3 F0");
	X(0x00C6,"E5 49 90 E6 B4 F0 02 02 C9 E5 4A 90 E6 B3 F0 E5");
	X(0x00D6,"4B 90 E6 B4 F0 02 02 C9 90 E6 BA E0 FF 12 0A E8");
	X(0x00E6,"AA 06 A9 07 7B 01 EA 49 60 0D EE 90 E6 B3 F0 EF");
	X(0x00F6,"90 E6 B4 F0 02 02 C9 90 E6 A0 E0 44 01 F0 02 02");
	X(0x0106,"C9 90 E6 A0 E0 44 01 F0 02 02 C9 12 0B 9D 02 02");
	X(0x0116,"C9 12 0B C0 02 02 C9 12 06 F5 02 02 C9 12 0B 8B");
	X(0x0126,"02 02 C9 90 E6 B8 E0 24 7F 60 2B 14 60 3C 24 02");
	X(0x0136,"60 03 02 01 C0 A2 0E E4 33 FF 25 E0 FF A2 10 E4");
	X(0x0146,"33 4F 90 E7 40 F0 E4 A3 F0 90 E6 8A F0 90 E6 8B");
	X(0x0156,"74 02 F0 02 02 C9 E4 90 E7 40 F0 A3 F0 90 E6 8A");
	X(0x0166,"F0 90 E6 8B 74 02 F0 02 02 C9 90 E6 BC E0 54 7E");
	X(0x0176,"FF 7E 00 E0 D3 94 80 40 06 7C 00 7D 01 80 04 7C");
	X(0x0186,"00 7D 00 EC 4E FE ED 4F 24 36 F5 82 74 00 3E F5");
	X(0x0196,"83 E4 93 FF 33 95 E0 FE EF 24 A1 FF EE 34 E6 8F");
	X(0x01A6,"82 F5 83 E0 54 01 90 E7 40 F0 E4 A3 F0 90 E6 8A");
	X(0x01B6,"F0 90 E6 8B 74 02 F0 02 02 C9 90 E6 A0 E0 44 01");
	X(0x01C6,"F0 02 02 C9 90 E6 B8 E0 24 FE 60 1D 24 02 60 03");
	X(0x01D6,"02 02 C9 90 E6 BA E0 B4 01 05 C2 0E 02 02 C9 90");
	X(0x01E6,"E6 A0 E0 44 01 F0 02 02 C9 90 E6 BA E0 70 58 90");
	X(0x01F6,"E6 BC E0 54 7E FF 7E 00 E0 D3 94 80 40 06 7C 00");
	X(0x0206,"7D 01 80 04 7C 00 7D 00 EC 4E FE ED 4F 24 36 F5");
	X(0x0216,"82 74 00 3E F5 83 E4 93 FF 33 95 E0 FE EF 24 A1");
	X(0x0226,"FF EE 34 E6 8F 82 F5 83 E0 54 FE F0 90 E6 BC E0");
	X(0x0236,"54 80 FF 13 13 13 54 1F FF E0 54 0F 2F 90 E6 83");
	X(0x0246,"F0 E0 44 20 F0 80 7C 90 E6 A0 E0 44 01 F0 80 73");
	X(0x0256,"90 E6 B8 E0 24 FE 60 20 24 02 70 67 90 E6 BA E0");
	X(0x0266,"B4 01 04 D2 0E 80 5C 90 E6 BA E0 64 02 60 54 90");
	X(0x0276,"E6 A0 E0 44 01 F0 80 4B 90 E6 BC E0 54 7E FF 7E");
	X(0x0286,"00 E0 D3 94 80 40 06 7C 00 7D 01 80 04 7C 00 7D");
	X(0x0296,"00 EC 4E FE ED 4F 24 36 F5 82 74 00 3E F5 83 E4");
	X(0x02A6,"93 FF 33 95 E0 FE EF 24 A1 FF EE 34 E6 8F 82 F5");
	X(0x02B6,"83 E0 44 01 F0 80 0C 12 09 7D 50 07 90 E6 A0 E0");
	X(0x02C6,"44 01 F0 90 E6 A0 E0 44 80 F0");

	X(0x02D0,"22");
	X(0x0033,"02 00 46");
	X(0x0046,"53 D8 EF 32");
	X(0x0003,"30 12 09 90 E6 80 E0 44 0A F0 80 07 90 E6 80 E0");
	X(0x0013,"44 08 F0 7F DC 7E 05 12 09 D0 90 E6 5D 74 FF F0");
	X(0x0023,"90 E6 5F F0 53 91 EF 90 E6 80 E0 54 F7 F0 22");

	X(0x09D0,"8E 18 8F 19 90 E6 00 E0 54 18 70 12 E5 19 24 01");
	X(0x09E0,"FF E4 35 18 C3 13 F5 18 EF 13 F5 19 80 15 90 E6");
	X(0x09F0,"00 E0 54 18 FF BF 10 0B E5 19 25 E0 F5 19 E5 18");
	X(0x0A00,"33 F5 18 E5 19 15 19 AE 18 70 02 15 18 4E 60 05");
	X(0x0A10,"12 0B AF 80 EE 22");

	X(0x0AE8,"A9 07");
	X(0x0AEA,"AE 50 AF 51 8F 82 8E 83 A3 E0 64 03 70 17 AD 01");
	X(0x0AFA,"19 ED 70 01 22 8F 82 8E 83 E0 7C 00 2F FD EC 3E");
	X(0x0B0A,"FE AF 05 80 DF 7E 00 7F 00");

	X(0x0B13,"22");
	X(0x0BAF,"74 00 F5 86 90 FD A5 7C 05 A3 E5 82 45 83 70 F9");
	X(0x0BBF,"FF");

	X(0x0043,"02 08 00");
	X(0x0053,"02 08 00");

	X(0x0800,"02 0B 2F 00 02 0B 75 00 02 0B 5F 00 02 0B 47 00");
	X(0x0810,"02 0A 16 00 02 07 BE 00 02 00 32 00 02 00 40 00");
	X(0x0820,"02 00 41 00 02 00 42 00 02 00 4A 00 02 00 4E 00");
	X(0x0830,"02 00 4F 00 02 00 50 00 02 00 51 00 02 00 52 00");
	X(0x0840,"02 06 FD 00 02 00 40 00 02 06 FE 00 02 06 FF 00");
	X(0x0850,"02 07 FB 00 02 07 FC 00 02 07 FD 00 02 07 FE 00");
	X(0x0860,"02 07 FF 00 02 00 40 00 02 00 40 00 02 00 40 00");
	X(0x0870,"02 0B D0 00 02 0B D1 00 02 0B D2 00 02 0B D3 00");
	X(0x0880,"02 0B D4 00 02 0B D5 00 02 0B D6 00 02 0B D7 00");
	X(0x0890,"02 0B D8 00 02 0B D9 00 02 0B DA 00 02 0B DB 00");
	X(0x08A0,"02 0B DC 00 02 0B DD 00 02 0B DE 00 02 0B DF 00");
	X(0x08B0,"02 0B E0 00 02 0B E1 00");

	X(0x0700,"12 01 00 02 00 00 00 40 04 23 04 02 00 00 01 02");
	X(0x0710,"00 01 0A 06 00 02 00 00 00 40 01 00 09 02 2E 00");
	X(0x0720,"01 01 00 C0 32 09 04 00 00 04 FF 00 00 00 07 05");
	X(0x0730,"02 02 00 02 00 07 05 04 02 00 02 00 07 05 86 02");
	X(0x0740,"00 02 00 07 05 88 02 00 02 00 09 02 2E 00 01 01");
	X(0x0750,"00 C0 32 09 04 00 00 04 FF 00 00 00 07 05 02 02");
	X(0x0760,"40 00 00 07 05 04 02 40 00 00 07 05 86 02 40 00");
	X(0x0770,"00 07 05 88 02 40 00 00 04 03 09 04 22 03 50 00");
	X(0x0780,"69 00 6E 00 6E 00 61 00 63 00 6C 00 65 00 20 00");
	X(0x0790,"53 00 79 00 73 00 74 00 65 00 6D 00 73 00 1E 03");
	X(0x07A0,"4D 00 6F 00 76 00 69 00 65 00 42 00 6F 00 78 00");
	X(0x07B0,"20 00 55 00 53 00 42 00 5F 00 42 00 00 00");

	X(0x08B8,"60 28 1A 18 00 00 00 00 00 00 00 00 00 00 00 00");
	X(0x08C8,"00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00");
	X(0x08D8,"00 00 00 00 00 00 00 00 00 00 00 00 C1 04 C1 00");
	X(0x08E8,"C1 0D 02 25 00 00 C1 87 C1 8A 04 28 00 00 00 00");
	X(0x08F8,"C1 09 02 35 01 00 02 2F 00 40 C1 02 C1 06 02 39");
	X(0x0908,"00 00 02 3B 00 00 C1 05 C1 0B C1 0C C1 01 04 40");
	X(0x9818,"00 03 D0 90");

	X(0x0592,"90 E6 00 E0 54 E7 44 10 F0 90 E6 01 E0 44 40 F0");
	X(0x05A2,"12 0B C8 E4 F5 B3 75 B4 FF 75 A0 10 75 B2 FB F5");
	X(0x05B2,"B5 F5 B6 53 80 FE 7F 01 FE 12 09 D0 43 80 01 43");
	X(0x05C2,"80 40 43 80 08 43 80 10 90 E6 10 74 A0 F0 90 E6");
	X(0x05D2,"11 F0 00 00 00 90 E6 12 74 A2 F0 00 00 00 90 E6");
	X(0x05E2,"13 74 A0 F0 00 00 00 90 E6 14 74 E2 F0 00 00 00");
	X(0x05F2,"90 E6 15 74 E0 F0 00 00 00 90 E6 91 74 80 F0 00");
	X(0x0602,"00 00 F0 00 00 00 90 E6 95 F0 00 00 00 F0 00 00");
	X(0x0612,"00 90 E6 04 F0 00 00 00 74 06 F0 00 00 00 E4 F0");
	X(0x0622,"90 E6 80 E0 30 E7 0E 75 35 01 75 36 00 75 2F 00");
	X(0x0632,"75 30 40 80 0C 75 35 00 75 36 20 75 2F 02 75 30");
	X(0x0642,"00 E4 F5 3E F5 3F 74 02 25 3F F5 82 E4 34 1A F5");
	X(0x0652,"83 E4 F0 05 3F E5 3F 70 02 05 3E 64 14 45 3E 70");
	X(0x0662,"E5 C2 08 43 AF 01 22");

	X(0x06F5,"90 E6 BA E0 F5 3D D3 22");

	X(0x0B8B,"90 E7 40 E5 3D F0 E4 90 E6 8A F0 90 E6 8B 04 F0");
	X(0x0B9B,"D3 22");

	X(0x0BC0,"90 E6 BA E0 F5 27 D3 22");

	X(0x0B9D,"90 E7 40 E5 27 F0 E4 90 E6 8A F0 90 E6 8B 04 F0");
	X(0x0BAD,"D3 22");

	X(0x097D,"90 E6 B9 E0 24 3C 60 25 24 F3 60 12 04 70 40 90");
	X(0x098D,"E6 04 E0 FF 43 07 80 00 00 00 EF F0 80 33 90 E6");
	X(0x099D,"04 E0 FF 53 07 7F 00 00 00 EF F0 80 24 30 08 08");
	X(0x09AD,"90 E7 40 74 01 F0 80 05 E4 90 E7 40 F0 00 00 00");
	X(0x09BD,"E4 90 E6 8A F0 00 00 00 90 E6 8B 04 F0 80 02 D3");
	X(0x09CD,"22 C3");

	X(0x09CF,"22");

	X(0x0B2F,"C0 E0 C0 83 C0 82 D2 0F 53 91 EF 90 E6 5D 74 01");
	X(0x0B3F,"F0 D0 82 D0 83 D0 E0 32");

	X(0x0B5F,"C0 E0 C0 83 C0 82 53 91 EF 90 E6 5D 74 04 F0 D0");
	X(0x0B6F,"82 D0 83 D0 E0 32");

	X(0x0B75,"C0 E0 C0 83 C0 82 53 91 EF 90 E6 5D 74 02 F0 D0");
	X(0x0B85,"82 D0 83 D0 E0 32");

	X(0x0A16,"C0 E0 C0 83 C0 82 85 4C 48 85 4D 49 85 49 82 85");
	X(0x0A26,"48 83 A3 74 02 F0 85 44 4A 85 45 4B 85 4B 82 85");
	X(0x0A36,"4A 83 A3 74 07 F0 53 91 EF 90 E6 5D 74 10 F0 D0");
	X(0x0A46,"82 D0 83 D0 E0 32");

	X(0x0B47,"C0 E0 C0 83 C0 82 D2 11 53 91 EF 90 E6 5D 74 08");
	X(0x0B57,"F0 D0 82 D0 83 D0 E0 32");

	X(0x07BE,"C0 E0 C0 83 C0 82 90 E6 80 E0 30 E7 20 85 44 48");
	X(0x07CE,"85 45 49 85 49 82 85 48 83 A3 74 02 F0 85 4C 4A");
	X(0x07DE,"85 4D 4B 85 4B 82 85 4A 83 A3 74 07 F0 53 91 EF");
	X(0x07EE,"90 E6 5D 74 20 F0 D0 82 D0 83 D0 E0 32");

	X(0x0032,"32");
	X(0x0040,"32");
	X(0x0041,"32");
	X(0x0042,"32");
	X(0x004A,"32");
	X(0x004E,"32");
	X(0x004F,"32");
	X(0x0050,"32");
	X(0x0051,"32");
	X(0x0052,"32");
	X(0x06FD,"32");
	X(0x06FE,"32");
	X(0x06FF,"32");
	X(0x07FB,"32");
	X(0x07FC,"32");
	X(0x07FD,"32");
	X(0x07FE,"32");
	X(0x07FF,"32");
	X(0x0BD0,"32");
	X(0x0BD1,"32");
	X(0x0BD2,"32");
	X(0x0BD3,"32");
	X(0x0BD4,"32");
	X(0x0BD5,"32");
	X(0x0BD6,"32");
	X(0x0BD7,"32");
	X(0x0BD8,"32");
	X(0x0BD9,"32");
	X(0x0BDA,"32");
	X(0x0BDB,"32");
	X(0x0BDC,"32");
	X(0x0BDD,"32");
	X(0x0BDE,"32");
	X(0x0BDF,"32");
	X(0x0BE0,"32");
	X(0x0BE1,"32");

	X(0x0BC8,"E4 F5 1F D2 E9 D2 AF 22");
	X(0x0A4C,"90 E6 78 E0 20 E6 F9 C2 E9 90 E6 78 E0 44 80 F0");
	X(0x0A5C,"EF 25 E0 90 E6 79 F0 90 E6 78 E0 30 E0 F9 90 E6");
	X(0x0A6C,"78 E0 44 40 F0 90 E6 78 E0 20 E6 F9 90 E6 78 E0");
	X(0x0A7C,"30 E1 D6 D2 E9 22");

	X(0x0AB6,"A9 07 90 E6 78 E0 20 E6 F9 E5 1F 70 23 90 E6 78");
	X(0x0AC6,"E0 44 80 F0 E9 25 E0 90 E6 79 F0 8D 1A AF 03 A9");
	X(0x0AD6,"07 75 1B 01 8A 1C 89 1D E4 F5 1E 75 1F 01 D3 22");
	X(0x0AE6,"C3 22");

	X(0x0A82,"A9 07 90 E6 78 E0 20 E6 F9 E5 1F 70 25 90 E6 78");
	X(0x0A92,"E0 44 80 F0 E9 25 E0 44 01 90 E6 79 F0 8D 1A AF");
	X(0x0AA2,"03 A9 07 75 1B 01 8A 1C 89 1D E4 F5 1E 75 1F 03");
	X(0x0AB2,"D3 22 C3 22");
	X(0x004B,"02 04 8A");

	X(0x048A,"C0 E0 C0 83 C0 82 C0 85 C0 84 C0 86 75 86 00 C0");
	X(0x049A,"D0 75 D0 00 C0 00 C0 01 C0 02 C0 03 C0 06 C0 07");
	X(0x04AA,"90 E6 78 E0 30 E2 06 75 1F 06 02 05 74 90 E6 78");
	X(0x04BA,"E0 20 E1 0C E5 1F 64 02 60 06 75 1F 07 02 05 74");
	X(0x04CA,"E5 1F 24 FE 60 5F 14 60 36 24 FE 70 03 02 05 65");
	X(0x04DA,"24 FC 70 03 02 05 71 24 08 60 03 02 05 74 AB 1B");
	X(0x04EA,"AA 1C A9 1D AF 1E 05 1E 8F 82 75 83 00 12 09 1D");
	X(0x04FA,"90 E6 79 F0 E5 1E 65 1A 70 70 75 1F 05 80 6B 90");
	X(0x050A,"E6 79 E0 AB 1B AA 1C A9 1D AE 1E 8E 82 75 83 00");
	X(0x051A,"12 09 4A 75 1F 02 E5 1A 64 01 70 4E 90 E6 78 E0");
	X(0x052A,"44 20 F0 80 45 E5 1A 24 FE B5 1E 07 90 E6 78 E0");
	X(0x053A,"44 20 F0 E5 1A 14 B5 1E 0A 90 E6 78 E0 44 40 F0");
	X(0x054A,"75 1F 00 90 E6 79 E0 AB 1B AA 1C A9 1D AE 1E 8E");
	X(0x055A,"82 75 83 00 12 09 4A 05 1E 80 0F 90 E6 78 E0 44");
	X(0x056A,"40 F0 75 1F 00 80 03 75 1F 00 53 91 DF D0 07 D0");
	X(0x057A,"06 D0 03 D0 02 D0 01 D0 00 D0 D0 D0 86 D0 84 D0");
	X(0x058A,"85 D0 82 D0 83 D0 E0 32");

	X(0x0000,"02 06 69");
	X(0x0669,"78 7F E4 F6 D8 FD 75 81 51 02 06 B0");
	X(0x091D,"BB 01 0C E5 82 29 F5 82 E5 83 3A F5 83 E0 22 50");
	X(0x092D,"06 E9 25 82 F8 E6 22 BB FE 06 E9 25 82 F8 E2 22");
	X(0x093D,"E5 82 29 F5 82 E5 83 3A F5 83 E4 93 22");
	X(0x094A,"F8 BB 01 0D E5 82 29 F5 82 E5 83 3A F5 83 E8 F0");
	X(0x095A,"22 50 06 E9 25 82 C8 F6 22 BB FE 05 E9 25 82 C8");
	X(0x096A,"F2 22");
	X(0x096C,"EB 9F F5 F0 EA 9E 42 F0 E9 9D 42 F0 E8 9C 45 F0");
	X(0x097C,"22");

	X(0x0675,"02 02 D1 E4 93 A3 F8 E4 93 A3 40 03 F6 80 01 F2");
	X(0x0685,"08 DF F4 80 29 E4 93 A3 F8 54 07 24 0C C8 C3 33");
	X(0x0695,"C4 54 0F 44 20 C8 83 40 04 F4 56 80 01 46 F6 DF");
	X(0x06A5,"E4 80 0B 01 02 04 08 10 20 40 80 90 08 B8 E4 7E");
	X(0x06B5,"01 93 60 BC A3 FF 54 3F 30 E5 09 54 1F FE E4 93");
	X(0x06C5,"A3 60 01 0E CF 54 C0 25 E0 60 A8 40 B8 E4 93 A3");
	X(0x06D5,"FA E4 93 A3 F8 E4 93 A3 C8 C5 82 C8 CA C5 83 CA");
	X(0x06E5,"F0 A3 C8 C5 82 C8 CA C5 83 CA DF E9 DE E7 80 BE");
	X(0x091C,"00");
	X(0x7F92,"00");
	X(0xE600,"00");

	return 0;
}

static int startup()
{
	int i,val;

	X(0x0851,"E4 F5 13 F5 12 F5 11 F5 10 C2 15 C2 12 D2 14 C2 13 12 0D 14 12 13 BE 12 10 44 12 13 58 7E 0E 7F 00 8E 45 8F 46 75 4D 0E 75 4E 12 75 43 0E 75 44 1C 75 4B 0E 75 4C 4A 75 4F 0E 75 50 78 90 E6 80");
	X(0x0891,"E0 30 E7 0E 85 43 47 85 44 48 85 4B 49 85 4C 4A 80 0C 85 4B 47 85 4C 48 85 43 49 85 44 4A EE 54 E0 70 03 02 09 C3 75 14 00 75 15 80 7E 0E 7F 00 8E 16 8F 17 C3 74 BC 9F FF 74 0E 9E CF 24 02 CF");
	X(0x08D1,"34 00 FE E4 8F 0F 8E 0E F5 0D F5 0C F5 0B F5 0A F5 09 F5 08 AF 0F AE 0E AD 0D AC 0C AB 0B AA 0A A9 09 A8 08 C3 12 10 FD 50 26 E5 15 25 0B F5 82 E5 14 35 0A F5 83 74 CD F0 E5 0B 24 01 F5 0B E4");
	X(0x0911,"35 0A F5 0A E4 35 09 F5 09 E4 35 08 F5 08 80 C4 E4 F5 0B F5 0A F5 09 F5 08 AF 0F AE 0E AD 0D AC 0C AB 0B AA 0A A9 09 A8 08 C3 12 10 FD 50 31 AE 0A AF 0B E5 17 2F F5 82 E5 16 3E F5 83 E0 FD E5");
	X(0x0951,"15 2F F5 82 E5 14 3E F5 83 ED F0 EF 24 01 F5 0B E4 3E F5 0A E4 35 09 F5 09 E4 35 08 F5 08 80 B9 85 14 45 85 15 46 74 00 24 80 FF 74 0E 34 FF FE C3 E5 4E 9F F5 4E E5 4D 9E F5 4D C3 E5 48 9F F5");
	X(0x0991,"48 E5 47 9E F5 47 C3 E5 4A 9F F5 4A E5 49 9E F5 49 C3 E5 44 9F F5 44 E5 43 9E F5 43 C3 E5 4C 9F F5 4C E5 4B 9E F5 4B C3 E5 50 9F F5 50 E5 4F 9E F5 4F D2 E8 43 D8 20 90 E6 68 E0 44 09 F0 90 E6");
	X(0x09D1,"5C E0 44 3D F0 D2 AF 90 E6 80 E0 20 E1 05 D2 16 12 12 A5 E5 80 30 E2 10 7F F4 7E 01 12 11 5D 90 E6 80 E0 54 F7 F0 80 03 12 13 FB 53 8E F8 C2 15 30 13 05 12 03 AC C2 13 30 15 34 12 00 31 50 2F");
	X(0x0A11,"C2 15 90 E6 80 E0 44 08 F0 12 0D D5 20 12 16 90 E6 82 E0 30 E7 04 E0 20 E1 F2 90 E6 82 E0 30 E6 04 E0 20 E0 E7 12 12 D4 90 E6 80 E0 54 F7 F0 12 00 56 80 BC");

	X(0x13FB,"90 E6 80 E0 44 08 F0 E5 80 30 E2 FB 7F F4 7E 01 12 11 5D 90 E6 80 E0 54 F7 F0 22");

	X(0x03AC,"90 E6 B9 E0 70 03 02 04 7F 14 70 03 02 05 20 24 FE 70 03 02 05 AC 24 FB 70 03 02 04 79 14 70 03 02 04 73 14 70 03 02 04 67 14 70 03 02 04 6D 24 05 60 03 02 06 13 90 E6 BB E0 24 FE 60 2C 14 60");
	X(0x03EC,"47 24 FD 60 16 14 60 31 24 06 70 65 E5 45 90 E6 B3 F0 E5 46 90 E6 B4 F0 02 06 1F E5 4D 90 E6 B3 F0 E5 4E 90 E6 B4 F0 02 06 1F E5 47 90 E6 B3 F0 E5 48 90 E6 B4 F0 02 06 1F E5 49 90 E6 B3 F0 E5");
	X(0x042C,"4A 90 E6 B4 F0 02 06 1F 90 E6 BA E0 FF 12 13 00 AA 06 A9 07 7B 01 EA 49 60 0D EE 90 E6 B3 F0 EF 90 E6 B4 F0 02 06 1F 90 E6 A0 E0 44 01 F0 02 06 1F 90 E6 A0 E0 44 01 F0 02 06 1F 12 14 C0 02 06");
	X(0x046C,"1F 12 14 EC 02 06 1F 12 14 E4 02 06 1F 12 14 AE 02 06 1F 90 E6 B8 E0 24 7F 60 2B 14 60 3C 24 02 60 03 02 05 16 A2 12 E4 33 FF 25 E0 FF A2 14 E4 33 4F 90 E7 40 F0 E4 A3 F0 90 E6 8A F0 90 E6 8B");
	X(0x04AC,"74 02 F0 02 06 1F E4 90 E7 40 F0 A3 F0 90 E6 8A F0 90 E6 8B 74 02 F0 02 06 1F 90 E6 BC E0 54 7E FF 7E 00 E0 D3 94 80 40 06 7C 00 7D 01 80 04 7C 00 7D 00 EC 4E FE ED 4F 24 D2 F5 82 74 14 3E F5");
	X(0x04EC,"83 E4 93 FF 33 95 E0 FE EF 24 A1 FF EE 34 E6 8F 82 F5 83 E0 54 01 90 E7 40 F0 E4 A3 F0 90 E6 8A F0 90 E6 8B 74 02 F0 02 06 1F 90 E6 A0 E0 44 01 F0 02 06 1F 90 E6 B8 E0 24 FE 60 1D 24 02 60 03");
	X(0x052C,"02 06 1F 90 E6 BA E0 B4 01 05 C2 12 02 06 1F 90 E6 A0 E0 44 01 F0 02 06 1F 90 E6 BA E0 70 58 90 E6 BC E0 54 7E FF 7E 00 E0 D3 94 80 40 06 7C 00 7D 01 80 04 7C 00 7D 00 EC 4E FE ED 4F 24 D2 F5");
	X(0x056C,"82 74 14 3E F5 83 E4 93 FF 33 95 E0 FE EF 24 A1 FF EE 34 E6 8F 82 F5 83 E0 54 FE F0 90 E6 BC E0 54 80 FF 13 13 13 54 1F FF E0 54 0F 2F 90 E6 83 F0 E0 44 20 F0 80 7C 90 E6 A0 E0 44 01 F0 80 73");
	X(0x05AC,"90 E6 B8 E0 24 FE 60 20 24 02 70 67 90 E6 BA E0 B4 01 04 D2 12 80 5C 90 E6 BA E0 64 02 60 54 90 E6 A0 E0 44 01 F0 80 4B 90 E6 BC E0 54 7E FF 7E 00 E0 D3 94 80 40 06 7C 00 7D 01 80 04 7C 00 7D");
	X(0x05EC,"00 EC 4E FE ED 4F 24 D2 F5 82 74 14 3E F5 83 E4 93 FF 33 95 E0 FE EF 24 A1 FF EE 34 E6 8F 82 F5 83 E0 44 01 F0 80 0C 12 06 27 50 07 90 E6 A0 E0 44 01 F0 90 E6 A0 E0 44 80 F0 22");
	X(0x0033,"02 00 1F");
	X(0x001F,"53 D8 EF 32");
	X(0x12D4,"90 E6 82 E0 30 E0 04 E0 20 E6 0B 90 E6 82 E0 30 E1 19 E0 30 E7 15 90 E6 80 E0 44 01 F0 7F 14 7E 00 12 11 5D 90 E6 80 E0 54 FE F0 22");
	X(0x0DD5,"90 E6 82 E0 44 C0 F0 90 E6 81 F0 43 87 01 00 00 00 00 00 22");
	X(0x12A5,"30 16 09 90 E6 80 E0 44 0A F0 80 07 90 E6 80 E0 44 08 F0 7F DC 7E 05 12 11 5D 90 E6 5D 74 FF F0 90 E6 5F F0 53 91 EF 90 E6 80 E0 54 F7 F0 22");
	X(0x115D,"8E 19 8F 1A 90 E6 00 E0 54 18 70 12 E5 1A 24 01 FF E4 35 19 C3 13 F5 19 EF 13 F5 1A 80 15 90 E6 00 E0 54 18 FF BF 10 0B E5 1A 25 E0 F5 1A E5 19 33 F5 19 E5 1A 15 1A AE 19 70 02 15 19 4E 60 05");
	X(0x119D,"12 0D E9 80 EE 22");
	X(0x1300,"A9 07 AE 4F AF 50 8F 82 8E 83 A3 E0 64 03 70 17 AD 01 19 ED 70 01 22 8F 82 8E 83 E0 7C 00 2F FD EC 3E FE AF 05 80 DF 7E 00 7F 00 22");
	X(0x0DE9,"74 00 F5 86 90 FD A5 7C 05 A3 E5 82 45 83 70 F9 22");
	X(0x0043,"02 0F 00");
	X(0x0053,"02 0F 00");
	X(0x0F00,"02 14 16 00 02 14 72 00 02 14 5C 00 02 14 2E 00 02 11 A3 00 02 0E BE 00 02 00 4A 00 02 00 52 00 02 0D FE 00 02 0D FF 00 02 0E FF 00 02 14 FC 00 02 14 FD 00 02 14 FE 00 02 14 FF 00 02 15 00 00");
	X(0x0F40,"02 15 01 00 02 00 52 00 02 15 02 00 02 15 03 00 02 15 04 00 02 15 05 00 02 15 06 00 02 15 07 00 02 15 08 00 02 00 52 00 02 00 52 00 02 00 52 00 02 15 09 00 02 15 0A 00 02 15 0B 00 02 15 0C 00");
	X(0x0F80,"02 15 0D 00 02 15 0E 00 02 15 0F 00 02 15 10 00 02 15 11 00 02 15 12 00 02 15 13 00 02 15 14 00 02 15 15 00 02 15 16 00 02 15 17 00 02 15 18 00 02 15 19 00 02 15 1A 00");
	X(0x0E00,"12 01 00 02 00 00 00 40 04 23 04 02 00 00 01 02 00 01 0A 06 00 02 00 00 00 40 01 00 09 02 2E 00 01 01 00 C0 32 09 04 00 00 04 FF 00 00 00 07 05 02 02 00 02 00 07 05 04 02 00 02 00 07 05 86 02");
	X(0x0E40,"00 02 00 07 05 88 02 00 02 00 09 02 2E 00 01 01 00 C0 32 09 04 00 00 04 FF 00 00 00 07 05 02 02 40 00 00 07 05 04 02 40 00 00 07 05 86 02 40 00 00 07 05 88 02 40 00 00 04 03 09 04 22 03 50 00");
	X(0x0E80,"69 00 6E 00 6E 00 61 00 63 00 6C 00 65 00 20 00 53 00 79 00 73 00 74 00 65 00 6D 00 73 00 1E 03 4D 00 6F 00 76 00 69 00 65 00 42 00 6F 00 78 00 20 00 55 00 53 00 42 00 5F 00 42 00 00 00");
	X(0x0B4D,"01 53 00 01 54 00");
	X(0x137C,"75 98 50 75 89 20 75 87 80 75 8D D9 75 8B D9 D2 8E 43 8E 10 D2 AC D2 BC D2 AF C2 99 7E 00 7F 00 22");
	X(0x1358,"E4 FF FE 7E 50 90 1A 87 E4 F0 A3 DE FC 7E 00 7F 50 E4 F5 51 F5 52 F5 57 F5 58 F5 55 F5 56 12 13 7C FE FF 22");
	X(0x0023,"02 0C 4D");
	X(0x0C4D,"C0 E0 C0 F0 C0 83 C0 82 C0 D0 75 D0 00 C0 00 C0 01 C0 02 C0 03 C0 04 C0 05 C0 06 C0 07 30 99 23 C2 99 C3 E5 58 95 52 E5 57 95 51 50 16 74 87 25 58 F5 82 E4 34 1A F5 83 E0 F5 99 05 58 E5 58 70");
	X(0x0C8D,"02 05 57 30 98 66 C2 98 AF 99 BF AA 06 75 55 00 75 56 00 C3 E5 56 94 50 E5 55 94 00 50 16 74 D9 25 56 F5 82 74 1A 35 55 F5 83 EF F0 05 56 E5 56 70 02 05 55 BF AA 0A E5 56 14 F5 53 75 2A AA 80");
	X(0x0CCD,"2B 74 D8 25 56 F5 82 74 1A 35 55 F5 83 E0 B5 2A 0A E5 56 14 F5 54 12 12 75 80 11 74 D8 25 56 F5 82 74 1A 35 55 F5 83 E0 25 2A F5 2A D0 07 D0 06 D0 05 D0 04 D0 03 D0 02 D0 01 D0 00 D0 D0 D0 82");
	X(0x0D0D,"D0 83 D0 F0 D0 E0 32");
	X(0x1275,"90 1A DA E0 64 44 70 27 90 1A E2 E0 FF B4 01 03 C2 04 22 EF 70 19 D2 04 90 1A E3 E0 FF B4 01 04 C2 04 80 05 EF 70 02 D2 04 90 1A E6 E0 F5 3B 22");
	X(0x0B53,"60 80 1A 00 01 01 01 01 25 3D 01 07 00 04 00 00 07 01 00 00 FB F3 E7 E7 E7 F7 F7 FF 00 09 12 12 C8 32 12 3F 01 01 01 01 25 3D 01 07 00 00 02 00 01 05 00 00 FB F3 F7 D7 D7 F7 F7 FF 09 09 12 12");
	X(0x0B93,"C8 F2 36 3F 01 01 01 01 25 01 01 07 00 00 00 00 01 02 00 00 FB F3 F7 E7 E7 E7 F7 FF 00 09 12 12 C8 2D 12 3F 01 01 01 01 01 2E 01 07 00 00 00 02 02 03 00 00 FB F3 F7 F7 D7 D7 D7 FF 09 09 12 12");
	X(0x0BD3,"00 C8 36 3F 47 1A 80 80 00 00 FF 06 E4 11");
	X(0x1044,"90 E6 01 74 CE F0 90 E6 F5 74 FF F0 90 1A 80 E0 90 E6 F3 F0 90 1A 81 E0 90 E6 C3 F0 90 1A 82 E0 90 E6 C1 F0 90 1A 83 E0 90 E6 C2 F0 90 1A 85 E0 90 E6 C0 F0 90 1A 86 E0 90 E6 F4 F0 75 AF 07 74");
	X(0x1084,"1A F5 9A 74 00 F5 9B 75 9D E4 E4 F5 9E FF 90 E6 7B E0 90 E6 7C F0 0F BF 80 F4 00 00 00 E4 90 E6 C4 F0 00 00 00 90 E6 C5 F0 22");
	X(0x110E,"8E 19 8F 1A E4 F5 27 F5 26 F5 25 F5 24 E5 BB 20 E7 2F 7F F0 7E 49 7D 02 7C 00 AB 27 AA 26 A9 25 A8 24 C3 12 10 FD 70 02 C3 22 E5 27 24 01 F5 27 E4 35 26 F5 26 E4 35 25 F5 25 E4 35 24 F5 24 80");
	X(0x114E,"CC E5 19 90 E6 F0 F0 90 E6 F1 E5 1A F0 D3 22");
	X(0x132C,"AD 07 AC 06 E4 FF E5 BB 30 E7 FB 90 E6 F1 E0 FF E5 BB 30 E7 FB 90 E6 F0 E0 FE 90 E6 F2 E0 FB EE EB FF 8D 82 8C 83 EE F0 A3 EF F0 22");
	X(0x14DC,"E5 BB 30 E7 FB 8F BB 22");
	X(0x1488,"AC 06 00 00 00 90 E6 D0 EC F0 00 00 00 90 E6 D1 EF F0 22");
	X(0x0026,"E5 BB 30 E7 FB EF 44 04 F5 BB 22");
	X(0x149B,"AC 06 00 00 00 90 E6 D0 EC F0 00 00 00 90 E6 D1 EF F0 22");
	X(0x0BE1,"60 28 1A EF 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 C1 05 C1 00 C1 11 C1 89 C1 8E 04 24 00 00 00 00 C1 0C 02 31");
	X(0x0C21,"01 00 02 2B 00 40 C1 02 C1 08 02 39 00 00 C1 06 C1 8A C1 0F C1 10 C1 01 04 3F 00 03 0D 40 04 35 00 00 00 00 C1 04 C1 0B 01 3B 00");
	X(0x0046,"53 80 F7 22");
	X(0x004E,"43 80 08 22");
	X(0x0DFA,"53 80 EF 22");
	X(0x0EFB,"43 80 10 22");
	X(0x1446,"7B 01 7A 1A 79 ED 7F 0C 7E 00 90 D0 00 EF F0 AE 02 AF 01 02 13 2C");
	X(0x0036,"8B 1B 8A 1C 89 1D 8C 1E 8D 1F 22");
	X(0x139D,"E4 F5 3D F5 3E 74 D9 25 3E F5 82 E4 34 1A F5 83 E4 F0 05 3E E5 3E 70 02 05 3D 64 14 45 3D 70 E5 22");
	X(0x0D14,"90 E6 00 E0 54 E7 44 10 F0 90 E6 01 E0 44 40 F0 12 14 F4 E4 F5 B3 75 B4 FF 75 A0 10 75 B2 FB F5 B5 F5 B6 F5 80 53 80 FE 7F 01 FE 12 11 5D 43 80 03 43 80 40 12 00 4E 12 0E FB 53 80 FD 90 E6 10");
	X(0x0D54,"74 A0 F0 90 E6 11 F0 00 00 00 90 E6 12 74 A2 F0 00 00 00 90 E6 13 74 A0 F0 00 00 00 90 E6 14 74 E2 F0 00 00 00 90 E6 15 74 E0 F0 00 00 00 90 E6 91 74 80 F0 00 00 00 F0 00 00 00 90 E6 95 F0 00");
	X(0x0D94,"00 00 F0 00 00 00 90 E6 04 F0 00 00 00 74 06 F0 00 00 00 E4 F0 90 E6 80 E0 30 E7 10 75 31 01 75 32 00 75 2B 00 75 2C 40 D2 07 80 0E 75 31 00 75 32 20 75 2B 02 75 2C 00 C2 07 12 13 9D 43 AF 01");
	X(0x0DD4,"22");
	X(0x13BE,"53 A0 DF 53 80 7F 7F 01 7E 00 12 11 5D 43 A0 20 7F 01 7E 00 12 11 5D 43 80 80 7F 01 7E 00 02 11 5D");
	X(0x0056,"30 05 73 E5 AA 20 E0 6E 90 E6 90 E0 FE 90 E6 91 E0 7C 00 24 00 F5 30 EC 3E F5 2F E4 F5 3D F5 3E C3 E5 3E 95 30 E5 3D 95 2F 50 45 74 00 25 3E F5 82 74 F0 35 3D F5 83 E0 75 28 00 F5 29 74 01 25");
	X(0x0096,"3E F5 82 74 F0 35 3D F5 83 E0 FE E4 EE 42 28 30 0D 11 AF 29 AE 28 12 11 0E 92 0D 20 0D 05 12 0D FA C2 0A 74 02 25 3E F5 3E E4 35 3D F5 3D 80 B0 90 E6 91 74 80 F0 20 00 03 02 03 10 E5 AA 30 E5");
	X(0x00D6,"03 02 03 10 12 14 46 90 1A EE E0 30 E1 12 7B 01 7A 1A 79 D7 7F 06 7E 00 12 14 50 12 14 46 80 E7 20 10 0C 90 1A D7 E0 B4 EE 1D A3 E0 B4 FF 18 C2 00 E4 90 1A D7 F0 A3 F0 F5 39 F5 3A C2 08 C2 02");
	X(0x0116,"C2 06 C2 01 12 00 4E 20 08 03 02 03 10 12 14 46 30 01 0A 90 1A ED E0 A3 30 E4 02 C2 01 E4 F5 27 F5 26 F5 25 F5 24 90 1A ED E0 A3 30 E4 03 02 01 CE AF 42 AE 41 AD 40 AC 3F AB 27 AA 26 A9 25 A8");
	X(0x0156,"24 C3 12 10 FD 50 71 20 01 6E 90 1A EE E0 30 E1 20 7B 01 7A 1A 79 D7 7F 06 7E 00 12 14 50 90 1A D7 E0 B4 EE 07 A3 E0 B4 FF 02 D2 0F 12 14 46 80 D9 12 14 46 E5 27 24 01 F5 27 E4 35 26 F5 26 E4");
	X(0x0196,"35 25 F5 25 E4 35 24 F5 24 AF 42 AE 41 AD 40 AC 3F AB 27 AA 26 A9 25 F8 C3 12 10 FD 70 88 12 0D FA 30 0F 07 D2 10 12 0E FB 80 0D D2 01 C2 0A E4 F5 42 F5 41 F5 40 F5 3F 30 10 03 02 03 10 E5 AA");
	X(0x01D6,"30 E5 03 02 02 E5 C3 E5 3A 95 2C E5 39 95 2B 40 03 02 02 E5 20 01 2D 30 0B 03 20 04 03 20 0B 17 90 D0 00 74 80 F0 30 09 1B AF 32 AE 31 12 14 9B 7F 02 12 00 26 80 0D D2 01 C2 0A E4 F5 42 F5 41");
	X(0x0216,"F5 40 F5 3F 30 01 23 E4 F5 3D F5 3E 74 00 25 3E F5 82 74 F8 35 3D F5 83 E4 F0 05 3E E5 3E 70 02 05 3D B4 00 E7 E5 3D B4 02 E2 E4 F5 27 F5 26 F5 25 F5 24 E5 BB 20 E7 4A 7F A0 7E 86 7D 01 7C 00");
	X(0x0256,"AB 27 AA 26 A9 25 A8 24 C3 12 10 FD 70 1D 90 E6 E3 04 F0 00 00 00 90 E6 04 74 80 F0 00 00 00 74 06 F0 00 00 00 E4 F0 C2 09 80 17 E5 27 24 01 F5 27 E4 35 26 F5 26 E4 35 25 F5 25 E4 35 24 F5 24");
	X(0x0296,"80 B1 90 E6 A5 E0 20 E3 F9 30 07 13 00 00 00 90 E6 98 74 02 F0 00 00 00 E4 90 E6 99 F0 80 11 00 00 00 E4 90 E6 98 F0 00 00 00 90 E6 99 74 40 F0 30 06 14 00 00 00 90 E6 04 74 80 F0 00 00 00 74");
	X(0x02D6,"06 F0 00 00 00 E4 F0 05 3A E5 3A 70 02 05 39 E5 3A 65 2C 70 04 E5 39 65 2B 70 1F F5 39 F5 3A C2 08 30 02 09 D2 06 D2 08 30 01 02 D2 10 E5 80 30 E3 05 12 00 46 80 03 12 00 4E 20 11 03 02 03 AB");
	X(0x0316,"E5 AA 30 E2 03 02 03 AB 90 D0 00 74 0C F0 7E 1A 7F ED 12 13 2C 90 1A EE E0 30 E1 12 7B 01 7A 1A 79 D7 7F 06 7E 00 12 14 50 12 14 46 80 E7 90 1A ED E0 A3 20 E4 1E 90 1A EE E0 30 E1 12 7B 01 7A");
	X(0x0356,"1A 79 D7 7F 06 7E 00 12 14 50 12 14 46 80 E7 12 14 46 80 DA 90 D0 00 74 80 F0 30 0E 11 E4 90 E6 95 F0 AF 32 AE 31 12 14 88 7F 01 12 14 DC E5 BB 30 E7 FB 05 3A E5 3A 70 02 05 39 B5 2C 17 E5 39");
	X(0x0396,"B5 2B 12 E5 80 30 E4 05 12 0D FA 80 03 12 0E FB E4 F5 39 F5 3A 22");
	X(0x0031,"D3 22");
	X(0x0041,"D3 22");
	X(0x14E4,"90 E6 BA E0 F5 3C D3 22");
	X(0x14AE,"90 E7 40 E5 3C F0 E4 90 E6 8A F0 90 E6 8B 04 F0 D3 22");
	X(0x14EC,"90 E6 BA E0 F5 23 D3 22");
	X(0x14C0,"90 E7 40 E5 23 F0 E4 90 E6 8A F0 90 E6 8B 04 F0 D3 22");
	X(0x0627,"90 E6 B9 E0 24 57 70 03 02 07 EA 14 70 03 02 07 B9 14 70 03 02 07 91 24 F1 70 03 02 08 05 24 F6 70 03 02 08 2B 14 60 2E 24 F4 60 18 04 60 03 02 08 4D 90 E6 04 E0 F5 18 43 18 80 00 00 00 E5 18");
	X(0x0667,"F0 02 08 4F 90 E6 04 E0 F5 18 53 18 7F 00 00 00 E5 18 F0 02 08 4F E4 90 E6 8A F0 00 00 00 90 E6 8B F0 90 E6 A0 E0 20 E1 F9 90 E7 40 E0 24 54 70 03 02 07 63 24 FB 70 03 02 07 58 14 60 24 14 60");
	X(0x06A7,"36 14 70 03 02 07 2D 24 F8 70 03 02 07 47 24 F3 70 03 02 07 7D 24 22 60 03 02 07 8F 12 13 BE 02 08 4F 90 E7 41 E0 B4 01 09 D2 05 D2 0D D2 0A 02 08 4F C2 05 02 08 4F 90 E7 41 E0 B4 01 23 90 D0");
	X(0x06E7,"00 74 08 F0 7F 01 7E 00 12 11 0E D2 09 D2 00 C2 0F C2 10 75 42 40 75 41 0D 75 40 03 75 3F 00 80 1D 90 D0 00 74 08 F0 E4 FF FE 12 11 0E D2 02 75 42 A0 75 41 86 75 40 01 75 3F 00 12 00 4E E4 90");
	X(0x0727,"E6 E3 F0 02 08 4F 90 E7 41 E0 B4 01 06 D2 0E D2 11 80 05 12 0E FB C2 11 E4 90 E6 DB F0 02 08 4F 90 E7 41 E0 B4 01 05 D2 08 02 08 4F C2 08 02 08 4F 90 E7 41 E0 90 D0 00 F0 02 08 4F 90 E7 41 E0");
	X(0x0767,"75 28 00 F5 29 A3 E0 FE E4 EE 42 28 AF 29 AE 28 12 11 0E 02 08 4F 90 E7 41 E0 60 06 53 80 FD 02 08 4F 43 80 02 02 08 4F D3 22 7E 1A 7F ED 12 13 2C 90 1A ED E0 90 E7 40 F0 90 1A EE E0 90 E7 41");
	X(0x07A7,"F0 E4 90 E6 8A F0 00 00 00 90 E6 8B 74 02 F0 02 08 4F E4 90 E6 8A F0 00 00 00 90 E6 8B F0 90 E6 A0 E0 20 E1 F9 90 E7 40 E0 75 2D 00 F5 2E A3 E0 75 33 00 F5 34 AF 2E FD 7A E7 7B 42 12 13 DF 92");
	X(0x07E7,"03 80 65 AF 2E AD 34 7A E7 7B 40 12 00 03 E4 90 E6 8A F0 00 00 00 90 E6 8B E5 34 F0 80 4A 90 E6 80 E0 30 E7 08 90 E7 40 74 01 F0 80 05 E4 90 E7 40 F0 00 00 00 E4 90 E6 8A F0 00 00 00 90 E6 8B");
	X(0x0827,"04 F0 80 24 30 0A 08 90 E7 40 74 01 F0 80 05 E4 90 E7 40 F0 00 00 00 E4 90 E6 8A F0 00 00 00 90 E6 8B 04 F0 80 02 D3 22 C3 22");
	X(0x1416,"C0 E0 C0 83 C0 82 D2 13 53 91 EF 90 E6 5D 74 01 F0 D0 82 D0 83 D0 E0 32");
	X(0x145C,"C0 E0 C0 83 C0 82 53 91 EF 90 E6 5D 74 04 F0 D0 82 D0 83 D0 E0 32 C0 E0 C0 83 C0 82 53 91 EF 90 E6 5D 74 02 F0 D0 82 D0 83 D0 E0 32");
	X(0x11A3,"C0 E0 C0 83 C0 82 85 4B 47 85 4C 48 85 48 82 85 47 83 A3 74 02 F0 85 43 49 85 44 4A 85 4A 82 85 49 83 A3 74 07 F0 53 91 EF 90 E6 5D 74 10 F0 D0 82 D0 83 D0 E0 32");
	X(0x142E,"C0 E0 C0 83 C0 82 D2 15 53 91 EF 90 E6 5D 74 08 F0 D0 82 D0 83 D0 E0 32");
	X(0x0EBE,"C0 E0 C0 83 C0 82 90 E6 80 E0 30 E7 20 85 43 47 85 44 48 85 48 82 85 47 83 A3 74 02 F0 85 4B 49 85 4C 4A 85 4A 82 85 49 83 A3 74 07 F0 53 91 EF 90 E6 5D 74 20 F0 D0 82 D0 83 D0 E0 32");
	X(0x004A,"32");
	X(0x0052,"32");
	X(0x0DFE,"32 32");
	X(0x0EFF,"32");
	X(0x14FC,"32 32 32 32 32 32 32 32 32 32 32 32 32 32 32 32 32 32 32 32 32 32 32 32 32 32 32 32 32 32 32");
	X(0x14F4,"E4 F5 5E D2 E9 D2 AF 22");
	X(0x11D9,"90 E6 78 E0 20 E6 F9 C2 E9 90 E6 78 E0 44 80 F0 EF 25 E0 90 E6 79 F0 90 E6 78 E0 30 E0 F9 90 E6 78 E0 44 40 F0 90 E6 78 E0 20 E6 F9 90 E6 78 E0 30 E1 D6 D2 E9 22");
	X(0x1243,"A9 07 90 E6 78 E0 20 E6 F9 E5 5E 70 23 90 E6 78 E0 44 80 F0 E9 25 E0 90 E6 79 F0 8D 59 AF 03 A9 07 75 5A 01 8A 5B 89 5C E4 F5 5D 75 5E 01 D3 22 C3 22");
	X(0x120F,"A9 07 90 E6 78 E0 20 E6 F9 E5 5E 70 25 90 E6 78 E0 44 80 F0 E9 25 E0 44 01 90 E6 79 F0 8D 59 AF 03 A9 07 75 5A 01 8A 5B 89 5C E4 F5 5D 75 5E 03 D3 22 C3 22");
	X(0x004B,"02 0A 45");
	X(0x0A45,"C0 E0 C0 83 C0 82 C0 85 C0 84 C0 86 75 86 00 C0 D0 75 D0 00 C0 00 C0 01 C0 02 C0 03 C0 06 C0 07 90 E6 78 E0 30 E2 06 75 5E 06 02 0B 2F 90 E6 78 E0 20 E1 0C E5 5E 64 02 60 06 75 5E 07 02 0B 2F");
	X(0x0A85,"E5 5E 24 FE 60 5F 14 60 36 24 FE 70 03 02 0B 20 24 FC 70 03 02 0B 2C 24 08 60 03 02 0B 2F AB 5A AA 5B A9 5C AF 5D 05 5D 8F 82 75 83 00 12 10 AE 90 E6 79 F0 E5 5D 65 59 70 70 75 5E 05 80 6B 90");
	X(0x0AC5,"E6 79 E0 AB 5A AA 5B A9 5C AE 5D 8E 82 75 83 00 12 10 DB 75 5E 02 E5 59 64 01 70 4E 90 E6 78 E0 44 20 F0 80 45 E5 59 24 FE B5 5D 07 90 E6 78 E0 44 20 F0 E5 59 14 B5 5D 0A 90 E6 78 E0 44 40 F0");
	X(0x0B05,"75 5E 00 90 E6 79 E0 AB 5A AA 5B A9 5C AE 5D 8E 82 75 83 00 12 10 DB 05 5D 80 0F 90 E6 78 E0 44 40 F0 75 5E 00 80 03 75 5E 00 53 91 DF D0 07 D0 06 D0 03 D0 02 D0 01 D0 00 D0 D0 D0 86 D0 84 D0");
	X(0x0B45,"85 D0 82 D0 83 D0 E0 32");
	X(0x0003,"12 12 0F E5 5E 24 FA 60 0E 14 60 06 24 07 70 F3 D3 22 E4 F5 5E D3 22 E4 F5 5E D3 22");
	X(0x13DF,"12 12 43 E5 5E 24 FA 60 0E 14 60 06 24 07 70 F3 D3 22 E4 F5 5E D3 22 E4 F5 5E D3 22");
	X(0x0000,"02 0F B8");
	X(0x0FB8,"78 7F E4 F6 D8 FD 75 81 5E 02 0F FF");
	X(0x10AE,"BB 01 0C E5 82 29 F5 82 E5 83 3A F5 83 E0 22 50 06 E9 25 82 F8 E6 22 BB FE 06 E9 25 82 F8 E2 22 E5 82 29 F5 82 E5 83 3A F5 83 E4 93 22 F8 BB 01 0D E5 82 29 F5 82 E5 83 3A F5 83 E8 F0 22 50 06");
	X(0x10EE,"E9 25 82 C8 F6 22 BB FE 05 E9 25 82 C8 F2 22 EB 9F F5 F0 EA 9E 42 F0 E9 9D 42 F0 E8 9C 45 F0 22");
	X(0x0FC4,"02 08 51 E4 93 A3 F8 E4 93 A3 40 03 F6 80 01 F2 08 DF F4 80 29 E4 93 A3 F8 54 07 24 0C C8 C3 33 C4 54 0F 44 20 C8 83 40 04 F4 56 80 01 46 F6 DF E4 80 0B 01 02 04 08 10 20 40 80 90 0B 4D E4 7E");
	X(0x1004,"01 93 60 BC A3 FF 54 3F 30 E5 09 54 1F FE E4 93 A3 60 01 0E CF 54 C0 25 E0 60 A8 40 B8 E4 93 A3 FA E4 93 A3 F8 E4 93 A3 C8 C5 82 C8 CA C5 83 CA F0 A3 C8 C5 82 C8 CA C5 83 CA DF E9 DE E7 80 BE");
	X(0x0C4C,"00");
	X(0xE600,"00");
// wait
	usleep(600000);
	C5x("C2 01");		// apparently this fails?

	for (i=0;i <= 8;i++)
		if (ReadA9(i) < 0)
			return -1;

	A9_Byte = 0x21;
	WriteA9(0x01,0x08); WriteA9(0x02,0xC0); WriteA9(0x03,0x30); WriteA9(0x04,0x90);
	WriteA9(0x05,0x90); WriteA9(0x06,0x6C); WriteA9(0x07,0x6C); WriteA9(0x08,0xA8);
	WriteA9(0x09,0x57); WriteA9(0x0A,0x80); WriteA9(0x0B,0x40); WriteA9(0x0C,0x40);
	WriteA9(0x0D,0x00); WriteA9(0x0E,0x89); WriteA9(0x0F,0x44); WriteA9(0x10,0x06);
	WriteA9(0x11,0x04); WriteA9(0x12,0xDA); WriteA9(0x13,0x91); WriteA9(0x14,0x00);
	WriteA9(0x15,0x14); WriteA9(0x16,0x36); WriteA9(0x17,0xDA); WriteA9(0x18,0x40);
	WriteA9(0x19,0x80); WriteA9(0x1A,0x00); WriteA9(0x1B,0x00); WriteA9(0x1C,0x00);
	WriteA9(0x1D,0x00); WriteA9(0x1E,0x00); WriteA9(0x1F,0xA1); WriteA9(0x30,0x00);
	WriteA9(0x31,0x72); WriteA9(0x32,0x03); WriteA9(0x34,0xCD); WriteA9(0x35,0xCC);
	WriteA9(0x36,0x3A); WriteA9(0x38,0x01); WriteA9(0x39,0x20); WriteA9(0x3A,0x08);
	WriteA9(0x40,0x00); WriteA9(0x41,0xFF); WriteA9(0x42,0xFF); WriteA9(0x43,0xFF);
	WriteA9(0x44,0xFF); WriteA9(0x45,0x77); WriteA9(0x46,0x77); WriteA9(0x47,0x77);
	WriteA9(0x48,0x77); WriteA9(0x49,0x77); WriteA9(0x4A,0x77); WriteA9(0x4B,0x77);
	WriteA9(0x4C,0x77); WriteA9(0x4D,0x77); WriteA9(0x4E,0x77); WriteA9(0x4F,0x77);
	WriteA9(0x50,0x77); WriteA9(0x51,0x77); WriteA9(0x52,0x77); WriteA9(0x53,0x77);
	WriteA9(0x54,0x77); WriteA9(0x55,0x77); WriteA9(0x56,0xFF); WriteA9(0x57,0xFF);
	WriteA9(0x58,0x00); WriteA9(0x59,0x47); WriteA9(0x5A,0x03); WriteA9(0x5B,0x03);
	WriteA9(0x5C,0x00); WriteA9(0x5D,0x00); WriteA9(0x5E,0x00); WriteA9(0x5F,0x00);
	WriteA9(0x60,0x00); WriteA9(0x61,0x21); WriteA9(0x62,0x6F); WriteA9(0x63,0x00);
	WriteA9(0x64,0x00); WriteA9(0x80,0x10); WriteA9(0x81,0x00); WriteA9(0x82,0x00);
	WriteA9(0x83,0x02); WriteA9(0x84,0xF0); WriteA9(0x85,0x00); WriteA9(0x86,0xF5);
	WriteA9(0x87,0x02); WriteA9(0x88,0xF0); WriteA9(0x8F,0x4B); WriteA9(0x90,0x40);
	WriteA9(0x91,0x08); WriteA9(0x92,0xF0); WriteA9(0x93,0x80); WriteA9(0x94,0x00);
	WriteA9(0x95,0x00); WriteA9(0x96,0xD0); WriteA9(0x97,0x02); WriteA9(0x98,0x01);
	WriteA9(0x99,0x00); WriteA9(0x9A,0x06); WriteA9(0x9B,0x01); WriteA9(0x9C,0xDF);
	WriteA9(0x9D,0x02); WriteA9(0x9E,0x06); WriteA9(0x9F,0x01); WriteA9(0xA0,0x01);
	WriteA9(0xA1,0x00); WriteA9(0xA2,0x00); WriteA9(0xA4,0x80); WriteA9(0xA5,0x3F);
	WriteA9(0xA6,0x3F); WriteA9(0xA8,0x00); WriteA9(0xA9,0x04); WriteA9(0xAA,0x00);
	WriteA9(0xAC,0x00); WriteA9(0xAD,0x02); WriteA9(0xAE,0x00); WriteA9(0xB0,0x00);
	WriteA9(0xB1,0x04); WriteA9(0xB2,0x00); WriteA9(0xB3,0x04); WriteA9(0xB4,0x01);
	WriteA9(0xB8,0x00); WriteA9(0xB9,0x00); WriteA9(0xBA,0x00); WriteA9(0xBB,0x00);
	WriteA9(0xBC,0x00); WriteA9(0xBD,0x00); WriteA9(0xBE,0x00); WriteA9(0xBF,0x00);
	WriteA9(0xC0,0x00); WriteA9(0xC1,0x08); WriteA9(0xC2,0x80); WriteA9(0xC3,0x80);
	WriteA9(0xC4,0x00); WriteA9(0xC5,0x00); WriteA9(0xC6,0xD0); WriteA9(0xC7,0x02);
	WriteA9(0xC8,0x00); WriteA9(0xC9,0x00); WriteA9(0xCA,0x06); WriteA9(0xCB,0x01);
	WriteA9(0xCC,0xD0); WriteA9(0xCD,0x02); WriteA9(0xCE,0x06); WriteA9(0xCF,0x01);
	WriteA9(0xD0,0x01); WriteA9(0xD1,0x00); WriteA9(0xD2,0x00); WriteA9(0xD4,0x80);
	WriteA9(0xD5,0x3F); WriteA9(0xD6,0x3F); WriteA9(0xD8,0x00); WriteA9(0xD9,0x04);
	WriteA9(0xDA,0x00); WriteA9(0xDC,0x00); WriteA9(0xDD,0x02); WriteA9(0xDE,0x00);
	WriteA9(0xE0,0x00); WriteA9(0xE1,0x04); WriteA9(0xE2,0x00); WriteA9(0xE3,0x04);
	WriteA9(0xE4,0x01); WriteA9(0xE8,0x00); WriteA9(0xE9,0x00); WriteA9(0xEA,0x00);
	WriteA9(0xEB,0x00); WriteA9(0xEC,0x00); WriteA9(0xED,0x00); WriteA9(0xEE,0x00);
	WriteA9(0xEF,0x00);
	// (whew)

        for (i=0;i <= 8;i++)
		if (ReadA9(i) < 0)
			return -1;

	WriteA9(0x02,0xC0); WriteA9(0x09,0x57); WriteA9(0x85,0x00); WriteA9(0x30,0xCD);
	WriteA9(0x31,0x20); WriteA9(0x32,0x03); WriteA9(0x34,0xFF); WriteA9(0x35,0xFF);
	WriteA9(0x36,0x3F);

	// next stuff
	A9_Byte = 0x00;
	WriteA9(0x00,0x4B); WriteA9(0x01,0x30); WriteA9(0x02,0x00); WriteA9(0x03,0x00);
	WriteA9(0x04,0x07); WriteA9(0x05,0x78); WriteA9(0x06,0x00); WriteA9(0x08,0x03);
	WriteA9(0x09,0x00); WriteA9(0x0A,0x00); WriteA9(0x0D,0x90); WriteA9(0x0E,0xF4);
	WriteA9(0x0F,0x00); WriteA9(0x10,0x15); WriteA9(0x11,0x96); WriteA9(0x12,0x15);
	WriteA9(0x13,0x13); WriteA9(0x14,0x54); WriteA9(0x15,0x00); WriteA9(0x16,0x00);
	WriteA9(0x17,0x00); WriteA9(0x18,0x00); WriteA9(0x19,0x00); WriteA9(0x1A,0x00);
	WriteA9(0x1B,0x00); WriteA9(0x1C,0x00); WriteA9(0x1E,0x00); WriteA9(0x1F,0x00);
	WriteA9(0x20,0x00); WriteA9(0x22,0x80); WriteA9(0x23,0x80); WriteA9(0x24,0x80);
	WriteA9(0x25,0x80); WriteA9(0x26,0x80); WriteA9(0x27,0x80); WriteA9(0x28,0x00);
	WriteA9(0x29,0xA1); WriteA9(0x2A,0x02); WriteA9(0x2B,0x00); WriteA9(0x2C,0x00);
	WriteA9(0x2D,0x00); WriteA9(0x2E,0x00); WriteA9(0x2F,0x00); WriteA9(0x30,0x00);
	WriteA9(0x31,0x00); WriteA9(0x32,0x00); WriteA9(0x33,0x00); WriteA9(0x5A,0x04);

	// next stuff
	A9_Byte = 0x18;
	WriteA9W(0x00,0x0F02);
	WriteA9W(0x01,0x0010);
	WriteA9W(0x02,0x25DF);
	WriteA9W(0x03,0x3F3F);
	WriteA9W(0x04,0x0202);
	WriteA9W(0x10,0x0000);
	WriteA9W(0x11,0x0000);
	WriteA9W(0x12,0x0000);
	WriteA9W(0x13,0x0000);
	WriteA9W(0x14,0x1011);
	WriteA9W(0x18,0x0000);
	WriteA9W(0x20,0x8080);
	WriteA9W(0x21,0x0000);
	WriteA9W(0x22,0x0000);
	WriteA9W(0x23,0x0000);
	WriteA9W(0x28,0x0010);

	for (i=0;i <= 8;i++)
		if (ReadA9(i) < 0)
			return -1;

	A9_Byte = 0x21;
	WriteA9(0x02,0xC0); WriteA9(0x09,0x57); WriteA9(0x85,0x00); WriteA9(0x30,0xCD);
	WriteA9(0x31,0x20); WriteA9(0x32,0x03); WriteA9(0x34,0xFF); WriteA9(0x35,0xFF);
	WriteA9(0x36,0x3F);

	if (ImmReadA9() < 0)
		return -1;

	C5("B1 1C");
	C5("A7");
	C5("B2 01");
	C5("B1 1C");

// 2880 firmware upload (TODO: This is a PAL image?)
	{
		unsigned char buffer[8192];
		int fd = open("../blob/2880fw.bin", O_RDONLY);
		int len,ret=0;
		if (fd < 0) {
			fprintf(stderr,"Cannot open 2880 firmware image\n");
			return -1;
		}

		while ((len = read(fd,buffer,8192)) > 0) {
			if (usb_bulk_write(dev_handle,0x02,buffer,len,2000) < 0) {
				fprintf(stderr,"Failed to write 2880 firmware image\n");
				ret = -1;
				break;
			}
		}

		close(fd);
		if (ret < 0) return ret;
	}

	for (i=0;i < 2;i++) {
		C5("B1 0C");
		if ((val=ImmReadAB()) < 0)
			return -1;
	}

	for (i=0;i < 4;i++) {
		C5("B1 06");
		if ((val=ImmReadAB()) < 0)
			return -1;

		C5("B1 0C");
		if ((val=ImmReadAB()) < 0)
			return -1;
	}

	for (i=0;i < 4;i++) {
		C5("B1 0C");
		if ((val=ImmReadAB()) < 0)
			return -1;
	}
	C5("B2 00");

	A9_Byte = 0x18;
	WriteA9W(0x20,0xD9D9);
	WriteA9W(0x10,0x0000);
	if ((val=ImmReadC4()) < 0) return -1;
	C5("B1 40");
	C5("B2 01");

	if (usb_bulk_write(dev_handle,0x02,monhex("0B 00 10 01 00 02 10 03 04 04 B0 05 00 06 00 07 10 08 32 09 00 0A 00 0B 05 0C 00 0D 00 0E 7F 0F E3 10 16 11 E8 12 01 13 00 14 07 15 00 16 00 17 00 18 00 19 00 1A 00 1B 00 1C 10 1D 00 1E 05 1F 00 20 00 21 00 22 00 23 00 24 00 25 00 26 00 27 00 28 00 29 00 2A 00 2B 00 2C 02 2D 00 2E 10 2F 00 30 00 31 00 32 00 33 00 34 00 35 00 36 00 37 01 B8"),0x72,2500) < 0x72) {
		fprintf(stderr,"Cannot upload 0x72 bytes of whatever\n");
		return -1;
	}

	C5("B1 0C");
	ImmReadAB();
	C5("B2 00");
	C5("B1 06");
	ImmReadAB();
	ImmReadC4();
	WriteA9W(0x10,0x0000);

// now for some bizzare reeason the sequence above sets up the TV output
// as PAL. We need NTSC. Anyway prepare the box for receipt of MPEG-2.
//
// IS THIS PART REALLY NECESSARY?
	X(0xE600,"01");
	X(0x14D2,"00 01 02 02 03 03 04 04 05 05");
	X(0x0851,"E4 F5 13 F5 12 F5 11 F5 10 C2 15 C2 12 D2 14 C2 13 12 0D 14 12 13 BE 12 10 44 12 13 58 7E 0E 7F 00 8E 45 8F 46 75 4D 0E 75 4E 12 75 43 0E 75 44 1C 75 4B 0E 75 4C 4A 75 4F 0E 75 50 78 90 E6 80");
	X(0x0891,"E0 30 E7 0E 85 43 47 85 44 48 85 4B 49 85 4C 4A 80 0C 85 4B 47 85 4C 48 85 43 49 85 44 4A EE 54 E0 70 03 02 09 C3 75 14 00 75 15 80 7E 0E 7F 00 8E 16 8F 17 C3 74 BC 9F FF 74 0E 9E CF 24 02 CF");
	X(0x08D1,"34 00 FE E4 8F 0F 8E 0E F5 0D F5 0C F5 0B F5 0A F5 09 F5 08 AF 0F AE 0E AD 0D AC 0C AB 0B AA 0A A9 09 A8 08 C3 12 10 FD 50 26 E5 15 25 0B F5 82 E5 14 35 0A F5 83 74 CD F0 E5 0B 24 01 F5 0B E4");
	X(0x0911,"35 0A F5 0A E4 35 09 F5 09 E4 35 08 F5 08 80 C4 E4 F5 0B F5 0A F5 09 F5 08 AF 0F AE 0E AD 0D AC 0C AB 0B AA 0A A9 09 A8 08 C3 12 10 FD 50 31 AE 0A AF 0B E5 17 2F F5 82 E5 16 3E F5 83 E0 FD E5");
	X(0x0951,"15 2F F5 82 E5 14 3E F5 83 ED F0 EF 24 01 F5 0B E4 3E F5 0A E4 35 09 F5 09 E4 35 08 F5 08 80 B9 85 14 45 85 15 46 74 00 24 80 FF 74 0E 34 FF FE C3 E5 4E 9F F5 4E E5 4D 9E F5 4D C3 E5 48 9F F5");
	X(0x0991,"48 E5 47 9E F5 47 C3 E5 4A 9F F5 4A E5 49 9E F5 49 C3 E5 44 9F F5 44 E5 43 9E F5 43 C3 E5 4C 9F F5 4C E5 4B 9E F5 4B C3 E5 50 9F F5 50 E5 4F 9E F5 4F D2 E8 43 D8 20 90 E6 68 E0 44 09 F0 90 E6");
	X(0x09D1,"5C E0 44 3D F0 D2 AF 90 E6 80 E0 20 E1 05 D2 16 12 12 A5 E5 80 30 E2 10 7F F4 7E 01 12 11 5D 90 E6 80 E0 54 F7 F0 80 03 12 13 FB 53 8E F8 C2 15 30 13 05 12 03 AC C2 13 30 15 34 12 00 31 50 2F");
	X(0x0A11,"C2 15 90 E6 80 E0 44 08 F0 12 0D D5 20 12 16 90 E6 82 E0 30 E7 04 E0 20 E1 F2 90 E6 82 E0 30 E6 04 E0 20 E0 E7 12 12 D4 90 E6 80 E0 54 F7 F0 12 00 56 80 BC");
	X(0x13FB,"90 E6 80 E0 44 08 F0 E5 80 30 E2 FB 7F F4 7E 01 12 11 5D 90 E6 80 E0 54 F7 F0 22");
	X(0x03AC,"90 E6 B9 E0 70 03 02 04 7F 14 70 03 02 05 20 24 FE 70 03 02 05 AC 24 FB 70 03 02 04 79 14 70 03 02 04 73 14 70 03 02 04 67 14 70 03 02 04 6D 24 05 60 03 02 06 13 90 E6 BB E0 24 FE 60 2C 14 60");
	X(0x03EC,"47 24 FD 60 16 14 60 31 24 06 70 65 E5 45 90 E6 B3 F0 E5 46 90 E6 B4 F0 02 06 1F E5 4D 90 E6 B3 F0 E5 4E 90 E6 B4 F0 02 06 1F E5 47 90 E6 B3 F0 E5 48 90 E6 B4 F0 02 06 1F E5 49 90 E6 B3 F0 E5");
	X(0x042C,"4A 90 E6 B4 F0 02 06 1F 90 E6 BA E0 FF 12 13 00 AA 06 A9 07 7B 01 EA 49 60 0D EE 90 E6 B3 F0 EF 90 E6 B4 F0 02 06 1F 90 E6 A0 E0 44 01 F0 02 06 1F 90 E6 A0 E0 44 01 F0 02 06 1F 12 14 C0 02 06");
	X(0x046C,"1F 12 14 EC 02 06 1F 12 14 E4 02 06 1F 12 14 AE 02 06 1F 90 E6 B8 E0 24 7F 60 2B 14 60 3C 24 02 60 03 02 05 16 A2 12 E4 33 FF 25 E0 FF A2 14 E4 33 4F 90 E7 40 F0 E4 A3 F0 90 E6 8A F0 90 E6 8B");
	X(0x04AC,"74 02 F0 02 06 1F E4 90 E7 40 F0 A3 F0 90 E6 8A F0 90 E6 8B 74 02 F0 02 06 1F 90 E6 BC E0 54 7E FF 7E 00 E0 D3 94 80 40 06 7C 00 7D 01 80 04 7C 00 7D 00 EC 4E FE ED 4F 24 D2 F5 82 74 14 3E F5");
	X(0x04EC,"83 E4 93 FF 33 95 E0 FE EF 24 A1 FF EE 34 E6 8F 82 F5 83 E0 54 01 90 E7 40 F0 E4 A3 F0 90 E6 8A F0 90 E6 8B 74 02 F0 02 06 1F 90 E6 A0 E0 44 01 F0 02 06 1F 90 E6 B8 E0 24 FE 60 1D 24 02 60 03");
	X(0x052C,"02 06 1F 90 E6 BA E0 B4 01 05 C2 12 02 06 1F 90 E6 A0 E0 44 01 F0 02 06 1F 90 E6 BA E0 70 58 90 E6 BC E0 54 7E FF 7E 00 E0 D3 94 80 40 06 7C 00 7D 01 80 04 7C 00 7D 00 EC 4E FE ED 4F 24 D2 F5");
	X(0x056C,"82 74 14 3E F5 83 E4 93 FF 33 95 E0 FE EF 24 A1 FF EE 34 E6 8F 82 F5 83 E0 54 FE F0 90 E6 BC E0 54 80 FF 13 13 13 54 1F FF E0 54 0F 2F 90 E6 83 F0 E0 44 20 F0 80 7C 90 E6 A0 E0 44 01 F0 80 73");
	X(0x05AC,"90 E6 B8 E0 24 FE 60 20 24 02 70 67 90 E6 BA E0 B4 01 04 D2 12 80 5C 90 E6 BA E0 64 02 60 54 90 E6 A0 E0 44 01 F0 80 4B 90 E6 BC E0 54 7E FF 7E 00 E0 D3 94 80 40 06 7C 00 7D 01 80 04 7C 00 7D");
	X(0x05EC,"00 EC 4E FE ED 4F 24 D2 F5 82 74 14 3E F5 83 E4 93 FF 33 95 E0 FE EF 24 A1 FF EE 34 E6 8F 82 F5 83 E0 44 01 F0 80 0C 12 06 27 50 07 90 E6 A0 E0 44 01 F0 90 E6 A0 E0 44 80 F0 22");
	X(0x0033,"02 00 1F");
	X(0x001F,"53 D8 EF 32");
	X(0x12D4,"90 E6 82 E0 30 E0 04 E0 20 E6 0B 90 E6 82 E0 30 E1 19 E0 30 E7 15 90 E6 80 E0 44 01 F0 7F 14 7E 00 12 11 5D 90 E6 80 E0 54 FE F0 22");
	X(0x0DD5,"90 E6 82 E0 44 C0 F0 90 E6 81 F0 43 87 01 00 00 00 00 00 22");
	X(0x12A5,"30 16 09 90 E6 80 E0 44 0A F0 80 07 90 E6 80 E0 44 08 F0 7F DC 7E 05 12 11 5D 90 E6 5D 74 FF F0 90 E6 5F F0 53 91 EF 90 E6 80 E0 54 F7 F0 22");
	X(0x115D,"8E 19 8F 1A 90 E6 00 E0 54 18 70 12 E5 1A 24 01 FF E4 35 19 C3 13 F5 19 EF 13 F5 1A 80 15 90 E6 00 E0 54 18 FF BF 10 0B E5 1A 25 E0 F5 1A E5 19 33 F5 19 E5 1A 15 1A AE 19 70 02 15 19 4E 60 05");
	X(0x119D,"12 0D E9 80 EE 22");
	X(0x1300,"A9 07 AE 4F AF 50 8F 82 8E 83 A3 E0 64 03 70 17 AD 01 19 ED 70 01 22 8F 82 8E 83 E0 7C 00 2F FD EC 3E FE AF 05 80 DF 7E 00 7F 00 22");
	X(0x0DE9,"74 00 F5 86 90 FD A5 7C 05 A3 E5 82 45 83 70 F9 22");
	X(0x0043,"02 0F 00");
	X(0x0053,"02 0F 00");
	X(0x0F00,"02 14 16 00 02 14 72 00 02 14 5C 00 02 14 2E 00 02 11 A3 00 02 0E BE 00 02 00 4A 00 02 00 52 00 02 0D FE 00 02 0D FF 00 02 0E FF 00 02 14 FC 00 02 14 FD 00 02 14 FE 00 02 14 FF 00 02 15 00 00");
	X(0x0F40,"02 15 01 00 02 00 52 00 02 15 02 00 02 15 03 00 02 15 04 00 02 15 05 00 02 15 06 00 02 15 07 00 02 15 08 00 02 00 52 00 02 00 52 00 02 00 52 00 02 15 09 00 02 15 0A 00 02 15 0B 00 02 15 0C 00");
	X(0x0F80,"02 15 0D 00 02 15 0E 00 02 15 0F 00 02 15 10 00 02 15 11 00 02 15 12 00 02 15 13 00 02 15 14 00 02 15 15 00 02 15 16 00 02 15 17 00 02 15 18 00 02 15 19 00 02 15 1A 00");
	X(0x0E00,"12 01 00 02 00 00 00 40 04 23 04 02 00 00 01 02 00 01 0A 06 00 02 00 00 00 40 01 00 09 02 2E 00 01 01 00 C0 32 09 04 00 00 04 FF 00 00 00 07 05 02 02 00 02 00 07 05 04 02 00 02 00 07 05 86 02");
	X(0x0E40,"00 02 00 07 05 88 02 00 02 00 09 02 2E 00 01 01 00 C0 32 09 04 00 00 04 FF 00 00 00 07 05 02 02 40 00 00 07 05 04 02 40 00 00 07 05 86 02 40 00 00 07 05 88 02 40 00 00 04 03 09 04 22 03 50 00");
	X(0x0E80,"69 00 6E 00 6E 00 61 00 63 00 6C 00 65 00 20 00 53 00 79 00 73 00 74 00 65 00 6D 00 73 00 1E 03 4D 00 6F 00 76 00 69 00 65 00 42 00 6F 00 78 00 20 00 55 00 53 00 42 00 5F 00 42 00 00 00");
	X(0x0B4D,"01 53 00 01 54 00");
	X(0x137C,"75 98 50 75 89 20 75 87 80 75 8D D9 75 8B D9 D2 8E 43 8E 10 D2 AC D2 BC D2 AF C2 99 7E 00 7F 00 22");
	X(0x1358,"E4 FF FE 7E 50 90 1A 87 E4 F0 A3 DE FC 7E 00 7F 50 E4 F5 51 F5 52 F5 57 F5 58 F5 55 F5 56 12 13 7C FE FF 22");
	X(0x0023,"02 0C 4D");
	X(0x0C4D,"C0 E0 C0 F0 C0 83 C0 82 C0 D0 75 D0 00 C0 00 C0 01 C0 02 C0 03 C0 04 C0 05 C0 06 C0 07 30 99 23 C2 99 C3 E5 58 95 52 E5 57 95 51 50 16 74 87 25 58 F5 82 E4 34 1A F5 83 E0 F5 99 05 58 E5 58 70");
	X(0x0C8D,"02 05 57 30 98 66 C2 98 AF 99 BF AA 06 75 55 00 75 56 00 C3 E5 56 94 50 E5 55 94 00 50 16 74 D9 25 56 F5 82 74 1A 35 55 F5 83 EF F0 05 56 E5 56 70 02 05 55 BF AA 0A E5 56 14 F5 53 75 2A AA 80");
	X(0x0CCD,"2B 74 D8 25 56 F5 82 74 1A 35 55 F5 83 E0 B5 2A 0A E5 56 14 F5 54 12 12 75 80 11 74 D8 25 56 F5 82 74 1A 35 55 F5 83 E0 25 2A F5 2A D0 07 D0 06 D0 05 D0 04 D0 03 D0 02 D0 01 D0 00 D0 D0 D0 82");
	X(0x0D0D,"D0 83 D0 F0 D0 E0 32");
	X(0x1275,"90 1A DA E0 64 44 70 27 90 1A E2 E0 FF B4 01 03 C2 04 22 EF 70 19 D2 04 90 1A E3 E0 FF B4 01 04 C2 04 80 05 EF 70 02 D2 04 90 1A E6 E0 F5 3B 22");
	X(0x0B53,"60 80 1A 00 01 01 01 01 25 3D 01 07 00 04 00 00 07 01 00 00 FB F3 E7 E7 E7 F7 F7 FF 00 09 12 12 C8 32 12 3F 01 01 01 01 25 3D 01 07 00 00 02 00 01 05 00 00 FB F3 F7 D7 D7 F7 F7 FF 09 09 12 12");
	X(0x0B93,"C8 F2 36 3F 01 01 01 01 25 01 01 07 00 00 00 00 01 02 00 00 FB F3 F7 E7 E7 E7 F7 FF 00 09 12 12 C8 2D 12 3F 01 01 01 01 01 2E 01 07 00 00 00 02 02 03 00 00 FB F3 F7 F7 D7 D7 D7 FF 09 09 12 12");
	X(0x0BD3,"00 C8 36 3F 47 1A 80 80 00 00 FF 06 E4 11");
	X(0x1044,"90 E6 01 74 CE F0 90 E6 F5 74 FF F0 90 1A 80 E0 90 E6 F3 F0 90 1A 81 E0 90 E6 C3 F0 90 1A 82 E0 90 E6 C1 F0 90 1A 83 E0 90 E6 C2 F0 90 1A 85 E0 90 E6 C0 F0 90 1A 86 E0 90 E6 F4 F0 75 AF 07 74");
	X(0x1084,"1A F5 9A 74 00 F5 9B 75 9D E4 E4 F5 9E FF 90 E6 7B E0 90 E6 7C F0 0F BF 80 F4 00 00 00 E4 90 E6 C4 F0 00 00 00 90 E6 C5 F0 22");
	X(0x110E,"8E 19 8F 1A E4 F5 27 F5 26 F5 25 F5 24 E5 BB 20 E7 2F 7F F0 7E 49 7D 02 7C 00 AB 27 AA 26 A9 25 A8 24 C3 12 10 FD 70 02 C3 22 E5 27 24 01 F5 27 E4 35 26 F5 26 E4 35 25 F5 25 E4 35 24 F5 24 80");
	X(0x114E,"CC E5 19 90 E6 F0 F0 90 E6 F1 E5 1A F0 D3 22");
	X(0x132C,"AD 07 AC 06 E4 FF E5 BB 30 E7 FB 90 E6 F1 E0 FF E5 BB 30 E7 FB 90 E6 F0 E0 FE 90 E6 F2 E0 FB EE EB FF 8D 82 8C 83 EE F0 A3 EF F0 22");
	X(0x14DC,"E5 BB 30 E7 FB 8F BB 22");
	X(0x1488,"AC 06 00 00 00 90 E6 D0 EC F0 00 00 00 90 E6 D1 EF F0 22");
	X(0x0026,"E5 BB 30 E7 FB EF 44 04 F5 BB 22");
	X(0x149B,"AC 06 00 00 00 90 E6 D0 EC F0 00 00 00 90 E6 D1 EF F0 22");
	X(0x0BE1,"60 28 1A EF 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 00 C1 05 C1 00 C1 11 C1 89 C1 8E 04 24 00 00 00 00 C1 0C 02 31");
	X(0x0C21,"01 00 02 2B 00 40 C1 02 C1 08 02 39 00 00 C1 06 C1 8A C1 0F C1 10 C1 01 04 3F 00 03 0D 40 04 35 00 00 00 00 C1 04 C1 0B 01 3B 00");
	X(0x0046,"53 80 F7 22");
	X(0x004E,"43 80 08 22");
	X(0x0DFA,"53 80 EF 22");
	X(0x0EFB,"43 80 10 22");
	X(0x1446,"7B 01 7A 1A 79 ED 7F 0C 7E 00 90 D0 00 EF F0 AE 02 AF 01 02 13 2C");
	X(0x0036,"8B 1B 8A 1C 89 1D 8C 1E 8D 1F 22");
	X(0x139D,"E4 F5 3D F5 3E 74 D9 25 3E F5 82 E4 34 1A F5 83 E4 F0 05 3E E5 3E 70 02 05 3D 64 14 45 3D 70 E5 22");
	X(0x0D14,"90 E6 00 E0 54 E7 44 10 F0 90 E6 01 E0 44 40 F0 12 14 F4 E4 F5 B3 75 B4 FF 75 A0 10 75 B2 FB F5 B5 F5 B6 F5 80 53 80 FE 7F 01 FE 12 11 5D 43 80 03 43 80 40 12 00 4E 12 0E FB 53 80 FD 90 E6 10");
	X(0x0D54,"74 A0 F0 90 E6 11 F0 00 00 00 90 E6 12 74 A2 F0 00 00 00 90 E6 13 74 A0 F0 00 00 00 90 E6 14 74 E2 F0 00 00 00 90 E6 15 74 E0 F0 00 00 00 90 E6 91 74 80 F0 00 00 00 F0 00 00 00 90 E6 95 F0 00");
	X(0x0D94,"00 00 F0 00 00 00 90 E6 04 F0 00 00 00 74 06 F0 00 00 00 E4 F0 90 E6 80 E0 30 E7 10 75 31 01 75 32 00 75 2B 00 75 2C 40 D2 07 80 0E 75 31 00 75 32 20 75 2B 02 75 2C 00 C2 07 12 13 9D 43 AF 01");
	X(0x0DD4,"22");
	X(0x13BE,"53 A0 DF 53 80 7F 7F 01 7E 00 12 11 5D 43 A0 20 7F 01 7E 00 12 11 5D 43 80 80 7F 01 7E 00 02 11 5D");
	X(0x0056,"30 05 73 E5 AA 20 E0 6E 90 E6 90 E0 FE 90 E6 91 E0 7C 00 24 00 F5 30 EC 3E F5 2F E4 F5 3D F5 3E C3 E5 3E 95 30 E5 3D 95 2F 50 45 74 00 25 3E F5 82 74 F0 35 3D F5 83 E0 75 28 00 F5 29 74 01 25");
	X(0x0096,"3E F5 82 74 F0 35 3D F5 83 E0 FE E4 EE 42 28 30 0D 11 AF 29 AE 28 12 11 0E 92 0D 20 0D 05 12 0D FA C2 0A 74 02 25 3E F5 3E E4 35 3D F5 3D 80 B0 90 E6 91 74 80 F0 20 00 03 02 03 10 E5 AA 30 E5");
	X(0x00D6,"03 02 03 10 12 14 46 90 1A EE E0 30 E1 12 7B 01 7A 1A 79 D7 7F 06 7E 00 12 14 50 12 14 46 80 E7 20 10 0C 90 1A D7 E0 B4 EE 1D A3 E0 B4 FF 18 C2 00 E4 90 1A D7 F0 A3 F0 F5 39 F5 3A C2 08 C2 02");
	X(0x0116,"C2 06 C2 01 12 00 4E 20 08 03 02 03 10 12 14 46 30 01 0A 90 1A ED E0 A3 30 E4 02 C2 01 E4 F5 27 F5 26 F5 25 F5 24 90 1A ED E0 A3 30 E4 03 02 01 CE AF 42 AE 41 AD 40 AC 3F AB 27 AA 26 A9 25 A8");
	X(0x0156,"24 C3 12 10 FD 50 71 20 01 6E 90 1A EE E0 30 E1 20 7B 01 7A 1A 79 D7 7F 06 7E 00 12 14 50 90 1A D7 E0 B4 EE 07 A3 E0 B4 FF 02 D2 0F 12 14 46 80 D9 12 14 46 E5 27 24 01 F5 27 E4 35 26 F5 26 E4");
	X(0x0196,"35 25 F5 25 E4 35 24 F5 24 AF 42 AE 41 AD 40 AC 3F AB 27 AA 26 A9 25 F8 C3 12 10 FD 70 88 12 0D FA 30 0F 07 D2 10 12 0E FB 80 0D D2 01 C2 0A E4 F5 42 F5 41 F5 40 F5 3F 30 10 03 02 03 10 E5 AA");
	X(0x01D6,"30 E5 03 02 02 E5 C3 E5 3A 95 2C E5 39 95 2B 40 03 02 02 E5 20 01 2D 30 0B 03 20 04 03 20 0B 17 90 D0 00 74 80 F0 30 09 1B AF 32 AE 31 12 14 9B 7F 02 12 00 26 80 0D D2 01 C2 0A E4 F5 42 F5 41");
	X(0x0216,"F5 40 F5 3F 30 01 23 E4 F5 3D F5 3E 74 00 25 3E F5 82 74 F8 35 3D F5 83 E4 F0 05 3E E5 3E 70 02 05 3D B4 00 E7 E5 3D B4 02 E2 E4 F5 27 F5 26 F5 25 F5 24 E5 BB 20 E7 4A 7F A0 7E 86 7D 01 7C 00");
	X(0x0256,"AB 27 AA 26 A9 25 A8 24 C3 12 10 FD 70 1D 90 E6 E3 04 F0 00 00 00 90 E6 04 74 80 F0 00 00 00 74 06 F0 00 00 00 E4 F0 C2 09 80 17 E5 27 24 01 F5 27 E4 35 26 F5 26 E4 35 25 F5 25 E4 35 24 F5 24");
	X(0x0296,"80 B1 90 E6 A5 E0 20 E3 F9 30 07 13 00 00 00 90 E6 98 74 02 F0 00 00 00 E4 90 E6 99 F0 80 11 00 00 00 E4 90 E6 98 F0 00 00 00 90 E6 99 74 40 F0 30 06 14 00 00 00 90 E6 04 74 80 F0 00 00 00 74");
	X(0x02D6,"06 F0 00 00 00 E4 F0 05 3A E5 3A 70 02 05 39 E5 3A 65 2C 70 04 E5 39 65 2B 70 1F F5 39 F5 3A C2 08 30 02 09 D2 06 D2 08 30 01 02 D2 10 E5 80 30 E3 05 12 00 46 80 03 12 00 4E 20 11 03 02 03 AB");
	X(0x0316,"E5 AA 30 E2 03 02 03 AB 90 D0 00 74 0C F0 7E 1A 7F ED 12 13 2C 90 1A EE E0 30 E1 12 7B 01 7A 1A 79 D7 7F 06 7E 00 12 14 50 12 14 46 80 E7 90 1A ED E0 A3 20 E4 1E 90 1A EE E0 30 E1 12 7B 01 7A");
	X(0x0356,"1A 79 D7 7F 06 7E 00 12 14 50 12 14 46 80 E7 12 14 46 80 DA 90 D0 00 74 80 F0 30 0E 11 E4 90 E6 95 F0 AF 32 AE 31 12 14 88 7F 01 12 14 DC E5 BB 30 E7 FB 05 3A E5 3A 70 02 05 39 B5 2C 17 E5 39");
	X(0x0396,"B5 2B 12 E5 80 30 E4 05 12 0D FA 80 03 12 0E FB E4 F5 39 F5 3A 22");
	X(0x0031,"D3 22");
	X(0x0041,"D3 22");
	X(0x14E4,"90 E6 BA E0 F5 3C D3 22");
	X(0x14AE,"90 E7 40 E5 3C F0 E4 90 E6 8A F0 90 E6 8B 04 F0 D3 22");
	X(0x14EC,"90 E6 BA E0 F5 23 D3 22");
	X(0x14C0,"90 E7 40 E5 23 F0 E4 90 E6 8A F0 90 E6 8B 04 F0 D3 22");
	X(0x0627,"90 E6 B9 E0 24 57 70 03 02 07 EA 14 70 03 02 07 B9 14 70 03 02 07 91 24 F1 70 03 02 08 05 24 F6 70 03 02 08 2B 14 60 2E 24 F4 60 18 04 60 03 02 08 4D 90 E6 04 E0 F5 18 43 18 80 00 00 00 E5 18");
	X(0x0667,"F0 02 08 4F 90 E6 04 E0 F5 18 53 18 7F 00 00 00 E5 18 F0 02 08 4F E4 90 E6 8A F0 00 00 00 90 E6 8B F0 90 E6 A0 E0 20 E1 F9 90 E7 40 E0 24 54 70 03 02 07 63 24 FB 70 03 02 07 58 14 60 24 14 60");
	X(0x06A7,"36 14 70 03 02 07 2D 24 F8 70 03 02 07 47 24 F3 70 03 02 07 7D 24 22 60 03 02 07 8F 12 13 BE 02 08 4F 90 E7 41 E0 B4 01 09 D2 05 D2 0D D2 0A 02 08 4F C2 05 02 08 4F 90 E7 41 E0 B4 01 23 90 D0");
	X(0x06E7,"00 74 08 F0 7F 01 7E 00 12 11 0E D2 09 D2 00 C2 0F C2 10 75 42 40 75 41 0D 75 40 03 75 3F 00 80 1D 90 D0 00 74 08 F0 E4 FF FE 12 11 0E D2 02 75 42 A0 75 41 86 75 40 01 75 3F 00 12 00 4E E4 90");
	X(0x0727,"E6 E3 F0 02 08 4F 90 E7 41 E0 B4 01 06 D2 0E D2 11 80 05 12 0E FB C2 11 E4 90 E6 DB F0 02 08 4F 90 E7 41 E0 B4 01 05 D2 08 02 08 4F C2 08 02 08 4F 90 E7 41 E0 90 D0 00 F0 02 08 4F 90 E7 41 E0");
	X(0x0767,"75 28 00 F5 29 A3 E0 FE E4 EE 42 28 AF 29 AE 28 12 11 0E 02 08 4F 90 E7 41 E0 60 06 53 80 FD 02 08 4F 43 80 02 02 08 4F D3 22 7E 1A 7F ED 12 13 2C 90 1A ED E0 90 E7 40 F0 90 1A EE E0 90 E7 41");
	X(0x07A7,"F0 E4 90 E6 8A F0 00 00 00 90 E6 8B 74 02 F0 02 08 4F E4 90 E6 8A F0 00 00 00 90 E6 8B F0 90 E6 A0 E0 20 E1 F9 90 E7 40 E0 75 2D 00 F5 2E A3 E0 75 33 00 F5 34 AF 2E FD 7A E7 7B 42 12 13 DF 92");
	X(0x07E7,"03 80 65 AF 2E AD 34 7A E7 7B 40 12 00 03 E4 90 E6 8A F0 00 00 00 90 E6 8B E5 34 F0 80 4A 90 E6 80 E0 30 E7 08 90 E7 40 74 01 F0 80 05 E4 90 E7 40 F0 00 00 00 E4 90 E6 8A F0 00 00 00 90 E6 8B");
	X(0x0827,"04 F0 80 24 30 0A 08 90 E7 40 74 01 F0 80 05 E4 90 E7 40 F0 00 00 00 E4 90 E6 8A F0 00 00 00 90 E6 8B 04 F0 80 02 D3 22 C3 22");
	X(0x1416,"C0 E0 C0 83 C0 82 D2 13 53 91 EF 90 E6 5D 74 01 F0 D0 82 D0 83 D0 E0 32");
	X(0x145C,"C0 E0 C0 83 C0 82 53 91 EF 90 E6 5D 74 04 F0 D0 82 D0 83 D0 E0 32 C0 E0 C0 83 C0 82 53 91 EF 90 E6 5D 74 02 F0 D0 82 D0 83 D0 E0 32");
	X(0x11A3,"C0 E0 C0 83 C0 82 85 4B 47 85 4C 48 85 48 82 85 47 83 A3 74 02 F0 85 43 49 85 44 4A 85 4A 82 85 49 83 A3 74 07 F0 53 91 EF 90 E6 5D 74 10 F0 D0 82 D0 83 D0 E0 32");
	X(0x142E,"C0 E0 C0 83 C0 82 D2 15 53 91 EF 90 E6 5D 74 08 F0 D0 82 D0 83 D0 E0 32");
	X(0x0EBE,"C0 E0 C0 83 C0 82 90 E6 80 E0 30 E7 20 85 43 47 85 44 48 85 48 82 85 47 83 A3 74 02 F0 85 4B 49 85 4C 4A 85 4A 82 85 49 83 A3 74 07 F0 53 91 EF 90 E6 5D 74 20 F0 D0 82 D0 83 D0 E0 32");
	X(0x004A,"32");
	X(0x0052,"32");
	X(0x0DFE,"32 32");
	X(0x0EFF,"32");
	X(0x14FC,"32 32 32 32 32 32 32 32 32 32 32 32 32 32 32 32 32 32 32 32 32 32 32 32 32 32 32 32 32 32 32");
	X(0x14F4,"E4 F5 5E D2 E9 D2 AF 22");
	X(0x11D9,"90 E6 78 E0 20 E6 F9 C2 E9 90 E6 78 E0 44 80 F0 EF 25 E0 90 E6 79 F0 90 E6 78 E0 30 E0 F9 90 E6 78 E0 44 40 F0 90 E6 78 E0 20 E6 F9 90 E6 78 E0 30 E1 D6 D2 E9 22");
	X(0x1243,"A9 07 90 E6 78 E0 20 E6 F9 E5 5E 70 23 90 E6 78 E0 44 80 F0 E9 25 E0 90 E6 79 F0 8D 59 AF 03 A9 07 75 5A 01 8A 5B 89 5C E4 F5 5D 75 5E 01 D3 22 C3 22");
	X(0x120F,"A9 07 90 E6 78 E0 20 E6 F9 E5 5E 70 25 90 E6 78 E0 44 80 F0 E9 25 E0 44 01 90 E6 79 F0 8D 59 AF 03 A9 07 75 5A 01 8A 5B 89 5C E4 F5 5D 75 5E 03 D3 22 C3 22");
	X(0x004B,"02 0A 45");
	X(0x0A45,"C0 E0 C0 83 C0 82 C0 85 C0 84 C0 86 75 86 00 C0 D0 75 D0 00 C0 00 C0 01 C0 02 C0 03 C0 06 C0 07 90 E6 78 E0 30 E2 06 75 5E 06 02 0B 2F 90 E6 78 E0 20 E1 0C E5 5E 64 02 60 06 75 5E 07 02 0B 2F");
	X(0x0A85,"E5 5E 24 FE 60 5F 14 60 36 24 FE 70 03 02 0B 20 24 FC 70 03 02 0B 2C 24 08 60 03 02 0B 2F AB 5A AA 5B A9 5C AF 5D 05 5D 8F 82 75 83 00 12 10 AE 90 E6 79 F0 E5 5D 65 59 70 70 75 5E 05 80 6B 90");
	X(0x0AC5,"E6 79 E0 AB 5A AA 5B A9 5C AE 5D 8E 82 75 83 00 12 10 DB 75 5E 02 E5 59 64 01 70 4E 90 E6 78 E0 44 20 F0 80 45 E5 59 24 FE B5 5D 07 90 E6 78 E0 44 20 F0 E5 59 14 B5 5D 0A 90 E6 78 E0 44 40 F0");
	X(0x0B05,"75 5E 00 90 E6 79 E0 AB 5A AA 5B A9 5C AE 5D 8E 82 75 83 00 12 10 DB 05 5D 80 0F 90 E6 78 E0 44 40 F0 75 5E 00 80 03 75 5E 00 53 91 DF D0 07 D0 06 D0 03 D0 02 D0 01 D0 00 D0 D0 D0 86 D0 84 D0");
	X(0x0B45,"85 D0 82 D0 83 D0 E0 32");
	X(0x0003,"12 12 0F E5 5E 24 FA 60 0E 14 60 06 24 07 70 F3 D3 22 E4 F5 5E D3 22 E4 F5 5E D3 22");
	X(0x13DF,"12 12 43 E5 5E 24 FA 60 0E 14 60 06 24 07 70 F3 D3 22 E4 F5 5E D3 22 E4 F5 5E D3 22");
	X(0x0000,"02 0F B8");
	X(0x0FB8,"78 7F E4 F6 D8 FD 75 81 5E 02 0F FF");
	X(0x10AE,"BB 01 0C E5 82 29 F5 82 E5 83 3A F5 83 E0 22 50 06 E9 25 82 F8 E6 22 BB FE 06 E9 25 82 F8 E2 22 E5 82 29 F5 82 E5 83 3A F5 83 E4 93 22 F8 BB 01 0D E5 82 29 F5 82 E5 83 3A F5 83 E8 F0 22 50 06");
	X(0x10EE,"E9 25 82 C8 F6 22 BB FE 05 E9 25 82 C8 F2 22 EB 9F F5 F0 EA 9E 42 F0 E9 9D 42 F0 E8 9C 45 F0 22");
	X(0x0FC4,"02 08 51 E4 93 A3 F8 E4 93 A3 40 03 F6 80 01 F2 08 DF F4 80 29 E4 93 A3 F8 54 07 24 0C C8 C3 33 C4 54 0F 44 20 C8 83 40 04 F4 56 80 01 46 F6 DF E4 80 0B 01 02 04 08 10 20 40 80 90 0B 4D E4 7E");
	X(0x1004,"01 93 60 BC A3 FF 54 3F 30 E5 09 54 1F FE E4 93 A3 60 01 0E CF 54 C0 25 E0 60 A8 40 B8 E4 93 A3 FA E4 93 A3 F8 E4 93 A3 C8 C5 82 C8 CA C5 83 CA F0 A3 C8 C5 82 C8 CA C5 83 CA DF E9 DE E7 80 BE");
	X(0x0C4C,"00");
	X(0xE600,"00");

	A9_Byte = 0x21;
	for (i=0;i <= 8;i++)
		if (ReadA9(i) < 0)
			return -1;

	A9_Byte = 0x00;
	WriteA9(0x00,0x0B); WriteA9(0x01,0x02); WriteA9(0x02,0x00); WriteA9(0x03,0x00);
	WriteA9(0x04,0x07); WriteA9(0x05,0x78); WriteA9(0x06,0x00); WriteA9(0x08,0x03);
	WriteA9(0x09,0x00); WriteA9(0x0A,0x00); WriteA9(0x0D,0x90); WriteA9(0x0E,0xF4);
	WriteA9(0x0F,0x00); WriteA9(0x10,0x1C); WriteA9(0x11,0x3E); WriteA9(0x12,0xF8);
	WriteA9(0x13,0xE0); WriteA9(0x14,0x43); WriteA9(0x15,0x00); WriteA9(0x16,0x00);
	WriteA9(0x17,0x00); WriteA9(0x18,0x00); WriteA9(0x19,0x00); WriteA9(0x1A,0x00);
	WriteA9(0x1B,0x00); WriteA9(0x1C,0x00); WriteA9(0x1E,0x00); WriteA9(0x1F,0x00);
	WriteA9(0x20,0x00); WriteA9(0x22,0x80); WriteA9(0x23,0x80); WriteA9(0x24,0x80);
	WriteA9(0x25,0x80); WriteA9(0x26,0x80); WriteA9(0x27,0x80); WriteA9(0x28,0x00);
	WriteA9(0x29,0xA1); WriteA9(0x2A,0x02); WriteA9(0x2B,0x00); WriteA9(0x2C,0x00);
	WriteA9(0x2D,0x00); WriteA9(0x2E,0x00); WriteA9(0x2F,0x00); WriteA9(0x30,0x00);
	WriteA9(0x31,0x00); WriteA9(0x32,0x00); WriteA9(0x33,0x00); WriteA9(0x5A,0x04);

	A9_Byte = 0x21;
	WriteA9(0x01,0x01); WriteA9(0x02,0xC0); WriteA9(0x03,0x30); WriteA9(0x04,0x90);
	WriteA9(0x05,0x90); WriteA9(0x06,0xEB); WriteA9(0x07,0xE0); WriteA9(0x08,0xF8);
	WriteA9(0x09,0x47); WriteA9(0x0A,0x80); WriteA9(0x0B,0x40); WriteA9(0x0C,0x40);
	WriteA9(0x0D,0x00); WriteA9(0x0E,0x89); WriteA9(0x0F,0x44); WriteA9(0x10,0x0E);
	WriteA9(0x11,0x00); WriteA9(0x12,0x00); WriteA9(0x13,0x91); WriteA9(0x14,0x04);
	WriteA9(0x15,0x11); WriteA9(0x16,0x03); WriteA9(0x17,0xDA); WriteA9(0x18,0x40);
	WriteA9(0x19,0x80); WriteA9(0x1A,0x00); WriteA9(0x1B,0x00); WriteA9(0x1C,0x00);
	WriteA9(0x1D,0x00); WriteA9(0x1E,0x00); WriteA9(0x1F,0xA1); WriteA9(0x30,0xBC);
	WriteA9(0x31,0xDF); WriteA9(0x32,0x02); WriteA9(0x33,0x00); WriteA9(0x34,0xCD);
	WriteA9(0x35,0xCC); WriteA9(0x36,0x3A); WriteA9(0x37,0x00); WriteA9(0x38,0x01);
	WriteA9(0x39,0x20); WriteA9(0x3A,0x08); WriteA9(0x40,0x00); WriteA9(0x41,0xFF);
	WriteA9(0x42,0xFF); WriteA9(0x43,0xFF); WriteA9(0x44,0xFF); WriteA9(0x45,0xFF);
	WriteA9(0x46,0xFF); WriteA9(0x47,0xFF); WriteA9(0x48,0xFF); WriteA9(0x49,0x77);
	WriteA9(0x4A,0x77); WriteA9(0x4B,0x77); WriteA9(0x4C,0x77); WriteA9(0x4D,0x77);
	WriteA9(0x4E,0x77); WriteA9(0x4F,0x77); WriteA9(0x50,0x77); WriteA9(0x51,0x77);
	WriteA9(0x52,0x77); WriteA9(0x53,0x77); WriteA9(0x54,0x77); WriteA9(0x55,0xFF);
	WriteA9(0x56,0xFF); WriteA9(0x57,0xFF); WriteA9(0x58,0x00); WriteA9(0x59,0x47);
	WriteA9(0x5A,0x06); WriteA9(0x5B,0x03); WriteA9(0x5C,0x00); WriteA9(0x5D,0x00);
	WriteA9(0x5E,0x00); WriteA9(0x5F,0x00); WriteA9(0x60,0x00); WriteA9(0x61,0x21);
	WriteA9(0x62,0x6F); WriteA9(0x63,0x00); WriteA9(0x64,0x00); WriteA9(0x80,0x10);
	WriteA9(0x81,0x00); WriteA9(0x82,0x00); WriteA9(0x83,0x01); WriteA9(0x84,0xF0);
	WriteA9(0x85,0x00); WriteA9(0x86,0xF5); WriteA9(0x87,0x02); WriteA9(0x88,0xF0);
	WriteA9(0x8F,0x4B); WriteA9(0x90,0x40); WriteA9(0x91,0x08); WriteA9(0x92,0x00);
	WriteA9(0x93,0x80); WriteA9(0x94,0x00); WriteA9(0x95,0x00); WriteA9(0x96,0xD0);
	WriteA9(0x97,0x02); WriteA9(0x98,0x01); WriteA9(0x99,0x00); WriteA9(0x9A,0x06);
	WriteA9(0x9B,0x01); WriteA9(0x9C,0xD0); WriteA9(0x9D,0x02); WriteA9(0x9E,0x06);
	WriteA9(0x9F,0x01); WriteA9(0xA0,0x01); WriteA9(0xA1,0x00); WriteA9(0xA2,0x00);
	WriteA9(0xA4,0x80); WriteA9(0xA5,0x3F); WriteA9(0xA6,0x3F); WriteA9(0xA8,0x00);
	WriteA9(0xA9,0x04); WriteA9(0xAA,0x00); WriteA9(0xAC,0x00); WriteA9(0xAD,0x02);
	WriteA9(0xAE,0x00); WriteA9(0xB0,0x00); WriteA9(0xB1,0x04); WriteA9(0xB2,0x00);
	WriteA9(0xB3,0x04); WriteA9(0xB4,0x01); WriteA9(0xB8,0x00); WriteA9(0xB9,0x00);
	WriteA9(0xBA,0x00); WriteA9(0xBB,0x00); WriteA9(0xBC,0x00); WriteA9(0xBD,0x00);
	WriteA9(0xBE,0x00); WriteA9(0xBF,0x00); WriteA9(0xC0,0x00); WriteA9(0xC1,0x08);
	WriteA9(0xC2,0x00); WriteA9(0xC3,0x80); WriteA9(0xC4,0x00); WriteA9(0xC5,0x00);
	WriteA9(0xC6,0xD0); WriteA9(0xC7,0x02); WriteA9(0xC8,0x00); WriteA9(0xC9,0x00);
	WriteA9(0xCA,0x06); WriteA9(0xCB,0x01); WriteA9(0xCC,0xD0); WriteA9(0xCD,0x02);
	WriteA9(0xCE,0x06); WriteA9(0xCF,0x01); WriteA9(0xD0,0x01); WriteA9(0xD1,0x00);
	WriteA9(0xD2,0x00); WriteA9(0xD4,0x80); WriteA9(0xD5,0x3F); WriteA9(0xD6,0x3F);
	WriteA9(0xD8,0x00); WriteA9(0xD9,0x04); WriteA9(0xDA,0x00); WriteA9(0xDC,0x00);
	WriteA9(0xDD,0x02); WriteA9(0xDE,0x00); WriteA9(0xE0,0x00); WriteA9(0xE1,0x04);
	WriteA9(0xE2,0x00); WriteA9(0xE3,0x04); WriteA9(0xE4,0x01); WriteA9(0xE8,0x00);
	WriteA9(0xE9,0x00); WriteA9(0xEA,0x00); WriteA9(0xEB,0x00); WriteA9(0xEC,0x00);
	WriteA9(0xED,0x00); WriteA9(0xEE,0x00); WriteA9(0xEF,0x00); WriteA9(0x02,0xC0);
	WriteA9(0x09,0x47); WriteA9(0x85,0x00); WriteA9(0x30,0xBC); WriteA9(0x31,0xDF);
	WriteA9(0x32,0x02); WriteA9(0x34,0xCD); WriteA9(0x35,0xCC); WriteA9(0x36,0x3A);
	
	A9_Byte = 0x18;
	WriteA9W(0x00,0x0F02);
	WriteA9W(0x01,0x0010);
	WriteA9W(0x02,0x25DF);
	WriteA9W(0x03,0x3F3F);
	WriteA9W(0x04,0x0202);
	WriteA9W(0x10,0xFFFF);
	WriteA9W(0x11,0x0000);
	WriteA9W(0x12,0x0000);
	WriteA9W(0x13,0x0202);
	WriteA9W(0x14,0x1011);
	WriteA9W(0x18,0x0000);
	WriteA9W(0x20,0x0000);
	WriteA9W(0x21,0x0000);
	WriteA9W(0x22,0x0000);
	WriteA9W(0x23,0x0001);
	WriteA9W(0x28,0x0010);
	C5("A7");
	C5("B1 1C");
	C5("B2 01");

	// 2880 firmware upload (NTSC image, right?)
	{
		unsigned char buffer[8192];
		int fd = open("../blob/2880ntscfw.bin",O_RDONLY);
		int len,ret=0;
		if (fd < 0) {
			fprintf(stderr,"Cannot open 2880 NTSC firmware image\n");
			return -1;
		}

		while ((len = read(fd,buffer,8192)) > 0) {
			if (usb_bulk_write(dev_handle,0x02,buffer,len,2000) < 0) {
				fprintf(stderr,"Failed to write 2880 firmware image\n");
				ret = -1;
				break;
			}
		}

		close(fd);
		if (ret < 0) return ret;
	}

	C5("B2 00");
	C5("B1 0C");
	for (i=0;i < 200;i++)
		if (ImmReadAB() < 0)
			return -1;

	A9_Byte = 0x18;
	WriteA9W(0x10,0x0000);
	C5("B1 08");
	C5("AC 01 00");
	C5("B4 01");
	WriteA9W(0x10,0x0000);
	C5("B1 08");
	C5("AC 03 00");

	// cool, begin the transfer

	return 0;
}

int PinnacleMovieBoxReset()
{
	return startup();
}

// according to UDA1380TT chipset register documentation,
// register 0x10 is the master volume control
int PinnacleMovieBoxSetMasterVolume(int l,int r)
{
	if (l < 0) l = 0;
	if (r < 0) r = 0;
	if (l > 255) l = 255;
	if (r > 255) r = 255;
	int w = (r << 8) | l;

	A9_Byte = 0x18;
	if (WriteA9W(0x10,w) < 0)
		return -1;

	return 0;
}

// according to CS4954 chipset register documentation,
// control register 4 allows various outputs on the video encoder
// to be powered up or down. Of course in Pinnacle's product there
// is no sense in powering on the RGB outputs since they aren't hooked up
//
// This also will not work once playback has started, so don't count on
// being able to switch back and forth "live".
int PinnacleMovieBoxEnableVideoOutputs(int flags)
{
	A9_Byte = 0x00;	// Talk to the video encoder on the board
	return WriteA9(0x04,flags ^ 0x3F);
}

static int unsetup()
{
	unsigned char c = 0;

	C5("B1 08");
	C5("AC 02 00");
	WriteA9W(0x10,0xFCFC);
	C5("B4 00");
	C5("B1 08");
	C5("AC 75 00");

	usb_control_msg(dev_handle,0xC0,0xCA,0,0,&c,1,5000);

// TODO: How to properly reset this thing?
//       After this program is finished the device won't init again

	return 0;
}

#undef X
#undef SPIT

// TODO for reference:
// PCM audio is sent to endpoint 0x2
// MPEG PES stream is sent to endpoint 0x4
//
// Why the device can't take the audio through the PES stream is beyond me...

int PinnacleMovieBoxInit()
{
	if (!(dev_bus = bus = usb_get_busses())) {
		fprintf(stderr,"libusb did not return any USB busses\n");
		return -1;
	}

	/* scan the buses for a Pinnacle MovieBox USB */
	while (!found && dev_bus) {
		dev_dev = dev_bus->devices;
		
		while (!found && dev_dev) {
			dev_desc = &dev_dev->descriptor;
			dev_conf =  dev_dev->config;
			fprintf(stdout, "Bus %d\tidVendor %#x\tidProduct %#x\t\t", 
				dev_dev->bus->location, 
				dev_desc->idVendor,
				dev_desc->idProduct
			);

			/* we're looking for a USB 2.0 device made by Pinnacle systems. */
			if (
				// dev_desc->bcdUSB == 0x200 &&	      // USB 2.0
				// dev_desc->bDeviceClass == 0 &&		  // Interface class
				// dev_desc->bDeviceSubClass == 0 &&
				// dev_desc->bDeviceProtocol == 0 &&
				dev_desc->idVendor == 0x2304 &&		  // Pinnacle Systems, Inc.
				(
					dev_desc->idProduct == 0x0223 ||  // DazzleTV Sat BDA Device
					dev_desc->idProduct == 0x0204     // MovieBox USB
				) &&	
				dev_desc->iManufacturer == 1 &&		  // Pinnacle Systems
				dev_desc->iProduct == 2 //&&		      // MovieBox USB, DazzleTV Sat BDA Device
				// dev_desc->bNumConfigurations == 1 &&
				// dev_conf->iConfiguration == 0
			) {
				fprintf(stdout, "Passed check\n");
				if (dev_conf->interface->num_altsetting > 0) {
					dev_if = dev_conf->interface->altsetting;
					fprintf(stdout, "\tOK\tAltsetting > 0\n");
				}
			} else {
				dev_if = NULL;
				fprintf(stdout, "\n");
			}

			if (	
				dev_if != NULL &&
				dev_if->bInterfaceClass == 255 &&
				dev_if->iInterface == 0 &&
				(
					dev_if->bNumEndpoints == 3 ||
					dev_if->bNumEndpoints == 4
				)
			) {
				fprintf(stdout, "\tOK\tInterfaces and endpoints fit\n");
				// Set all to NULL
				for (int i=0; i < dev_if->bNumEndpoints; i++) {
					dev_ep_out[i] = dev_ep_in[i] = NULL;
				}

				// Now try to set values
				for (int i=0; i < dev_if->bNumEndpoints; i++) {
					struct usb_endpoint_descriptor *d = &dev_if->endpoint[i];

					// all endpoints on these things are bulk transfers
					if (d->bmAttributes != 2) {
						fprintf(stdout, "Hop");
						continue;
					}
					
					// TODO add handling for DazzleTV Sat BDA Device
					// dev_desc->idProduct == 0x0223 ||  // DazzleTV Sat BDA Device
					// dev_desc->idProduct == 0x0204     // MovieBox USB
					fprintf(stdout, "\t\taddr:%#x\n", d->bEndpointAddress);
					switch (d->bEndpointAddress) {
						case 0x02:	dev_ep_out[0] = d;	break;
						case 0x04:	dev_ep_out[1] = d;	break;
						case 0x86:	dev_ep_in[0] = d;	break;
						case 0x88:	dev_ep_in[1] = d;	break;
						default:
							fprintf(stdout, "\t\t -> No match for addr:%#x\n", d->bEndpointAddress);
					}
				}

				if (	
					dev_ep_out[0] != NULL && dev_ep_in[0] != NULL &&
					dev_ep_out[1] != NULL && dev_ep_in[1] != NULL
				) {
					found = 1;
				} else {
					fprintf(stderr, "\t->\t%d\tEP Out");
				}
			} else if (dev_if != NULL) {
				// We found the device but something was wrong
				fprintf(stdout, "\t%s\t%d\t dev_if->bInterfaceClass == 255 \n", dev_if->bInterfaceClass == 255 ? "OK" : "->", dev_if->bInterfaceClass);
				fprintf(stdout, "\t%s\t%d\t dev_if->iInterface == 0 \n", dev_if->iInterface == 0 ? "OK" : "->", dev_if->iInterface);
				fprintf(stdout, "\t%s\t%d\t dev_if->bNumEndpoints == 4 \n", dev_if->bNumEndpoints == 4 ? "OK" : "->", dev_if->bNumEndpoints);
			}

			if (!found)
				dev_dev = dev_dev->next;
		}

		if (!found)
			dev_bus = dev_bus->next;
	}

	if (!found)
		fprintf(stderr,"Cannot find device\n");
		return -1;

	if (!(dev_handle = usb_open(dev_dev))) {
		fprintf(stderr,"Cannot open device\n");
		return -1;
	}
	if (usb_set_configuration(dev_handle,1) < 0) {
		fprintf(stderr,"Cannot set configuration\n");
		return -1;
	}
	if (usb_claim_interface(dev_handle,0) < 0) {
		fprintf(stderr,"Cannot claim interface\n");
		return -1;
	}

// mimick the transfers that Pinnacle's device drivers send when it's first plugged in
	if (knock_knock() < 0) {
		fprintf(stderr,"Device initialization failed\n");
		return -1;
	}

// mimick the additional packets sent when Studio 9 starts up
	if (startup() < 0) {
		fprintf(stderr,"Device secondary init failed\n");
		return -1;
	}

	return 0;
}

static unsigned char video_tmp[2048*32];
int PinnacleMovieBoxWriteVideo(unsigned char *buf,int len)
{
	int ret = 0,i;

	if (!dev_handle)
		return -1;

	// apparently keeping the MovieBox going in face of various MPEG errors
	// is like pulling teeth. It doesn't wanna. What a wimp.
	usb_clear_halt(dev_handle,0x04);

	// unfortunately we must swap the bytes before sending?
	while (len > 0) {
		int s = len;
		if (s > (2048*32)) s = 2048*32;

		for (i=0;i < s;i += 2) {
			video_tmp[i+1] = buf[i  ];
			video_tmp[i  ] = buf[i+1];
		}
		len -= s;
		buf += s;

		i = usb_bulk_write(dev_handle,0x04,video_tmp,s,5000);
		if (i > 0) ret += i;
		if (i < s) break;
	}

	return ret;
}

int PinnacleMovieBoxFree()
{
	if (dev_handle) {
		unsetup();
		fprintf(stderr,"Closing device...\n");
		usb_close(dev_handle);
		dev_handle = NULL;
	}

	return 0;
}

int PinnacleMovieBoxDeviceRemoved()
{
	// TODO: Use libusb to detect sudden removal of the device
	return 0;
}

